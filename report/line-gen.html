<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE å‹•ç•«å°è©±ç”¢ç”Ÿå™¨</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2canvas for Screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ•´å¹²æ“¾ */
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Icons ---
    const Icons = {
        Play: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
        Pause: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
        RotateCcw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
        Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
        User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
        Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        Battery: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="13" x2="23" y2="11"/></svg>,
        Wifi: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
        Signal: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 20V4"/></svg>,
        ArrowLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
        Phone: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
        Menu: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
        ImageIcon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
        Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        Edit2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
        X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
        Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
        Video: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>,
        Square: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
        Maximize: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>,
        Minimize: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>,
        Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
        Eye: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
        EyeOff: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
        Palette: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13.5 22H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5h12a5 5 0 0 1 5 5v5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>,
    };

    const App = () => {
        // --- State ---
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/4140/4140048.png";
        const [avatar, setAvatar] = useState(defaultAvatar);
        
        // Clean Mode States
        const [isCleanMode, setIsCleanMode] = useState(false);
        const [showCleanControls, setShowCleanControls] = useState(true);
        const [cleanBgColor, setCleanBgColor] = useState('bg-gray-900'); // Default black

        // é è¨­è…³æœ¬
        const [messages, setMessages] = useState([
            { id: 1, side: 'left', name: 'å…‹æ‹‰éŒ¢', content: 'ä½ å–œæ­¡æ°´æœè›‹ç³•å—ï¼Ÿå› ç‚ºç–«æƒ…å‡ºä¸äº†åœ‹ï¼Œæœ€è¿‘çœ‹åˆ°ä¸­å±±ç«™æœ‰å®¶æŠ˜ç”°è“èˆ–ï¼Œéƒ½å•äººæœ‰æ²’æœ‰åƒé', time: '07:06', read: true, type: 'text' },
            { id: 2, side: 'left', name: 'å…‹æ‹‰éŒ¢', content: 'æ¯å¤©å…©é»ä¸€ç·šçš„ä¸Šç­ ä¸€æ—©éƒ½çœ‹åˆ¥äººçš„è²“ç…§ç‰‡ å¿ƒæƒ…æœƒå¥½ä¸€é»ï½', time: '07:10', read: true, type: 'text' },
            { id: 3, side: 'right', name: 'æˆ‘', content: 'Hi~ ä½ å¥½ ğŸ™‚\nå¾ˆå°‘å¥³ç”Ÿèƒ½æŠ—æ‹’ç”œé»çš„èª˜æƒ‘å§\næŠ˜ç”°è“èˆ–æˆ‘æ²’åƒéè€¶\næˆ‘ä¹Ÿå¾ˆå–œæ­¡è²“è²“~ å“ˆ', time: '08:27', read: true, type: 'text' },
            { id: 4, side: 'left', name: 'å…‹æ‹‰éŒ¢', content: 'æˆ‘å®¶é™„è¿‘ä¹Ÿæœ‰å¾ˆå¤šç”œé»åº—', time: '09:46', read: true, type: 'text' },
            { id: 5, side: 'right', name: 'æˆ‘', content: 'ä½ å¾ˆæ„›ç”œé»å—ï¼Ÿ\næ„Ÿè¦ºå¾ˆé—œæ³¨', time: '12:46', read: true, type: 'text' },
            { id: 6, side: 'right', name: 'æˆ‘', content: 'æ—©ä¸Šçœ‹äº†ä»€éº¼è²“ç…§ç‰‡ï¼Ÿ', time: '12:47', read: true, type: 'text' },
            { id: 7, side: 'left', name: 'å…‹æ‹‰éŒ¢', content: 'https://images.unsplash.com/photo-1541781777631-fa9527560d0e?q=80&w=2940&auto=format&fit=crop', time: '12:49', read: true, type: 'image' },
            { id: 8, side: 'left', name: 'å…‹æ‹‰éŒ¢', content: 'æ—©ä¸Šçœ‹çš„è²“ç…§~ æƒ³åƒä»–ä¸€æ¨£ç¹¼çºŒåœ¨è¢«çª©è£¡', time: '12:49', read: true, type: 'text' },
        ]);

        // æ§åˆ¶è®Šæ•¸
        const [isPlaying, setIsPlaying] = useState(false);
        const [visibleCount, setVisibleCount] = useState(messages.length);
        const [playSpeed, setPlaySpeed] = useState(1000);
        
        // éŒ„å½±è®Šæ•¸
        const [isRecording, setIsRecording] = useState(false);
        const mediaRecorderRef = useRef(null);
        const recordedChunksRef = useRef([]);

        // è¼¸å…¥è®Šæ•¸
        const [editingId, setEditingId] = useState(null);
        const [inputSide, setInputSide] = useState('left');
        const [inputText, setInputText] = useState('');
        const [inputType, setInputType] = useState('text');
        const [inputTime, setInputTime] = useState('12:50');
        const [inputName, setInputName] = useState('å…‹æ‹‰éŒ¢');
        const [chatTitle, setChatTitle] = useState('å…‹æ‹‰éŒ¢');
        const [bgImage, setBgImage] = useState(null);

        // Refs
        const chatEndRef = useRef(null);
        const fileInputRef = useRef(null);
        const msgImageInputRef = useRef(null);

        // Effects
        useEffect(() => {
            if (chatEndRef.current) {
                chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }
        }, [visibleCount, messages]);

        useEffect(() => {
            let interval;
            if (isPlaying) {
                if (visibleCount < messages.length) {
                    interval = setInterval(() => {
                        setVisibleCount(prev => prev + 1);
                    }, playSpeed);
                } else {
                    setIsPlaying(false);
                    // Feature: Auto show menu when playback ends in clean mode
                    if (isCleanMode) {
                        setShowCleanControls(true);
                    }
                }
            }
            return () => clearInterval(interval);
        }, [isPlaying, visibleCount, messages.length, playSpeed, isCleanMode]);

        // Handlers
        const handleAddOrUpdateMessage = () => {
            if (!inputText.trim()) return;
            const messageData = { side: inputSide, name: inputSide === 'left' ? inputName : 'æˆ‘', content: inputText, time: inputTime, read: true, type: inputType };

            if (editingId) {
                setMessages(messages.map(msg => msg.id === editingId ? { ...msg, ...messageData } : msg));
                setEditingId(null);
            } else {
                setMessages([...messages, { ...messageData, id: Date.now() }]);
                if (!isPlaying && visibleCount === messages.length) {
                    setVisibleCount(messages.length + 1);
                }
            }
            setInputText('');
            setInputType('text');
        };

        const handleEditClick = (msg) => {
            setEditingId(msg.id);
            setInputSide(msg.side);
            setInputText(msg.content);
            setInputTime(msg.time);
            setInputType(msg.type);
            if (msg.side === 'left') {
                setInputName(msg.name);
            }
        };

        const handleCancelEdit = () => {
            setEditingId(null);
            setInputText('');
            setInputType('text');
        };

        const handleDeleteMessage = (id) => {
            const newMsgs = messages.filter(m => m.id !== id);
            setMessages(newMsgs);
            if (visibleCount > newMsgs.length) {
                setVisibleCount(newMsgs.length);
            }
            if (editingId === id) {
                handleCancelEdit();
            }
        };

        const handleAvatarUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => setAvatar(reader.result);
                reader.readAsDataURL(file);
            }
        };

        const handleMsgImageUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setInputText(reader.result);
                    setInputType('image');
                };
                reader.readAsDataURL(file);
            }
        };

        const handlePlay = () => {
            if (visibleCount === messages.length) setVisibleCount(0);
            setIsPlaying(true);
            // Feature: Auto hide menu when play starts in clean mode
            if (isCleanMode) {
                setShowCleanControls(false);
            }
        };
        const handlePause = () => setIsPlaying(false);
        const handleReset = () => {
            setIsPlaying(false);
            setVisibleCount(0);
        };
        const handleShowAll = () => {
            setIsPlaying(false);
            setVisibleCount(messages.length);
        };

        // Export & Record Logic
        const handleExportImage = () => {
            const element = document.getElementById('phone-preview-container');
            if (!element) return;
            const originalStyle = element.style.overflow;
            const originalBorder = element.style.borderRadius;

            window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                const link = document.createElement('a');
                link.download = `chat_screen_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                element.style.overflow = originalStyle;
                element.style.borderRadius = originalBorder;
            }).catch(err => alert("æˆªåœ–å¤±æ•—"));
        };

        const handleExportLongImage = () => {
            const originalPhone = document.getElementById('phone-preview-container');
            if (!originalPhone) return;

            const clonedPhone = originalPhone.cloneNode(true);
            clonedPhone.style.height = 'auto';
            clonedPhone.style.overflow = 'visible';
            clonedPhone.style.borderRadius = '0';
            clonedPhone.style.border = 'none';
            clonedPhone.style.boxShadow = 'none';

            const clonedContent = clonedPhone.querySelector('#chat-content-area');
            if (clonedContent) {
                clonedContent.style.height = 'auto';
                clonedContent.style.overflow = 'visible';
                clonedContent.style.flex = 'none';
            }

            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.width = '380px'; 
            container.appendChild(clonedPhone);
            document.body.appendChild(container);

            window.html2canvas(clonedPhone, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                const link = document.createElement('a');
                link.download = `chat_full_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(container);
            }).catch(err => {
                console.error("é•·æˆªåœ–å¤±æ•—:", err);
                alert("é•·æˆªåœ–å¤±æ•—");
                if (document.body.contains(container)) document.body.removeChild(container);
            });
        };

        const handleStartRecording = async () => {
            try {
                // Request high resolution
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { 
                        displaySurface: "browser",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    }, 
                    audio: false 
                });

                // Auto-enter clean mode and hide UI for recording
                setIsCleanMode(true);
                setShowCleanControls(false); // Auto hide UI
                
                // Wait for UI transition
                setTimeout(() => {
                    // Auto-Reset and Play
                    setVisibleCount(0);
                    setIsPlaying(true);
                    
                    // High bitrate options
                    const options = { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 5000000 };
                    const supported = MediaRecorder.isTypeSupported(options.mimeType);
                    mediaRecorderRef.current = new MediaRecorder(stream, supported ? options : undefined);
                    
                    recordedChunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = (event) => {
                        if (event.data.size > 0) recordedChunksRef.current.push(event.data);
                    };
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(recordedChunksRef.current, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        document.body.appendChild(a);
                        a.style = 'display: none';
                        a.href = url;
                        a.download = `chat_video_${Date.now()}.webm`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        setIsRecording(false);
                        setIsCleanMode(false); 
                        setShowCleanControls(true); // Restore UI
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                }, 1000); 

            } catch (err) {
                if (err.name === 'NotAllowedError' || err.message.includes('permissions policy')) {
                    alert("è«‹ä½¿ç”¨ç´”æ·¨æ¨¡å¼é…åˆé›»è…¦å…§å»ºéŒ„å½±åŠŸèƒ½");
                } else {
                    console.error(err);
                    alert("éŒ„å½±å¤±æ•—: " + err.message);
                }
            }
        };
        const handleStopRecording = () => {
            if (mediaRecorderRef.current && isRecording) mediaRecorderRef.current.stop();
        };

        const toggleCleanBg = () => {
            if (cleanBgColor === 'bg-gray-900') setCleanBgColor('bg-green-500'); // Chroma Green
            else if (cleanBgColor === 'bg-green-500') setCleanBgColor('bg-blue-600'); // Chroma Blue (Optional)
            else setCleanBgColor('bg-gray-900');
        };

        return (
            <div className="min-h-screen bg-gray-100 flex flex-col md:flex-row font-sans text-gray-800">
                {/* ç·¨è¼¯å€ */}
                <div className={`${isCleanMode ? 'hidden' : 'w-full md:w-1/2'} p-6 bg-white shadow-xl z-10 overflow-y-auto h-screen transition-all duration-300`}>
                    <h1 className="text-2xl font-bold mb-6 flex items-center gap-2 text-green-600">
                        <Icons.Send size={24} /> LINE å‹•ç•«å°è©±ç”¢ç”Ÿå™¨
                    </h1>

                    {/* åŒ¯å‡ºå€ */}
                    <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h2 className="font-semibold mb-3 flex items-center gap-2 text-blue-800">
                            <Icons.Settings size={18} /> åŒ¯å‡ºèˆ‡åˆ†äº«
                        </h2>
                        <div className="flex flex-wrap gap-3">
                            <button onClick={handleExportImage} className="flex items-center gap-2 px-4 py-2 bg-white border border-blue-300 text-blue-700 rounded hover:bg-blue-100 shadow-sm">
                                <Icons.Camera size={18} /> ç•«é¢æˆªåœ–
                            </button>
                            <button onClick={handleExportLongImage} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm">
                                <Icons.Download size={18} /> é•·æˆªåœ–
                            </button>
                            {!isRecording ? (
                                <button onClick={handleStartRecording} className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 shadow-sm">
                                    <Icons.Video size={18} /> é–‹å§‹éŒ„å½±
                                </button>
                            ) : (
                                <button onClick={handleStopRecording} className="flex items-center gap-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 shadow-sm animate-pulse">
                                    <Icons.Square size={18} /> åœæ­¢éŒ„å½±
                                </button>
                            )}
                            <button onClick={() => setIsCleanMode(true)} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 shadow-sm">
                                <Icons.Maximize size={18} /> ç´”æ·¨æ¨¡å¼
                            </button>
                        </div>
                        <p className="text-xs text-blue-400 mt-2">
                            * é»æ“Šã€Œé–‹å§‹éŒ„å½±ã€å¾Œï¼Œç¨‹å¼å°‡è‡ªå‹•é€²å…¥ç´”æ·¨æ¨¡å¼ä¸¦é–‹å§‹æ’­æ”¾ã€‚
                        </p>
                    </div>

                    {/* è¨­å®šå€ */}
                    <div className="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h2 className="font-semibold mb-3 flex items-center gap-2 text-gray-700">
                            <Icons.Settings size={18} /> èŠå¤©å®¤è¨­å®š
                        </h2>
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">èŠå¤©å®¤åç¨±</label>
                                    <input type="text" value={chatTitle} onChange={(e) => setChatTitle(e.target.value)} className="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">å°æ–¹æš±ç¨±</label>
                                    <input type="text" value={inputName} onChange={(e) => setInputName(e.target.value)} className="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none" />
                                </div>
                            </div>
                            <div className="flex items-center gap-4 border-t pt-4">
                                <div className="w-16 h-16 rounded-full bg-gray-200 overflow-hidden border border-gray-300 relative group">
                                    {avatar ? <img src={avatar} alt="avatar" className="w-full h-full object-cover" /> : <Icons.User className="w-full h-full p-3 text-gray-400" />}
                                </div>
                                <button onClick={() => fileInputRef.current.click()} className="px-4 py-2 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 flex items-center gap-2">
                                    <Icons.Upload size={16} /> æ›´æ›å¤§é ­ç…§
                                </button>
                                <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={handleAvatarUpload} />
                            </div>
                        </div>
                    </div>

                    {/* è¼¸å…¥å€ */}
                    <div className={`mb-6 p-4 rounded-lg border transition-colors ${editingId ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-200'}`}>
                        <div className="flex justify-between mb-3">
                            <div className="flex gap-2">
                                <button onClick={() => setInputSide('left')} className={`flex-1 px-4 py-2 rounded font-medium ${inputSide === 'left' ? 'bg-white text-gray-800 border-2 border-gray-300' : 'bg-gray-200 text-gray-500'}`}>å°æ–¹</button>
                                <button onClick={() => setInputSide('right')} className={`flex-1 px-4 py-2 rounded font-medium ${inputSide === 'right' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>æˆ‘</button>
                            </div>
                            <div className="flex gap-2 text-sm">
                                <button onClick={() => { setInputType('text'); setInputText(''); }} className={`px-3 py-1 rounded ${inputType === 'text' ? 'bg-green-100 text-green-700 font-bold' : 'bg-gray-100 text-gray-500'}`}>æ–‡å­—</button>
                                <button onClick={() => msgImageInputRef.current.click()} className={`px-3 py-1 rounded flex items-center gap-1 ${inputType === 'image' ? 'bg-green-100 text-green-700 font-bold' : 'bg-gray-100 text-gray-500'}`}><Icons.ImageIcon size={14} /> åœ–ç‰‡</button>
                                <input ref={msgImageInputRef} type="file" accept="image/*" className="hidden" onChange={handleMsgImageUpload} />
                            </div>
                        </div>
                        {inputType === 'text' ? (
                            <textarea value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="è¼¸å…¥è¨Šæ¯..." className="w-full p-3 border rounded min-h-[80px]" />
                        ) : (
                            <div className="w-full p-3 border rounded bg-gray-50 flex justify-center">{inputText ? <img src={inputText} className="h-24 object-contain" /> : <span className="text-gray-400">è«‹ä¸Šå‚³åœ–ç‰‡</span>}</div>
                        )}
                        <div className="flex justify-between items-center mt-3">
                            <input type="time" value={inputTime} onChange={(e) => setInputTime(e.target.value)} className="p-1 border rounded bg-white text-sm" />
                            <div className="flex gap-2">
                                {editingId && <button onClick={handleCancelEdit} className="px-4 py-2 bg-gray-400 text-white rounded">å–æ¶ˆ</button>}
                                <button onClick={handleAddOrUpdateMessage} className={`px-6 py-2 text-white rounded ${editingId ? 'bg-yellow-600' : 'bg-green-600'}`}>{editingId ? 'æ›´æ–°' : 'åŠ å…¥'}</button>
                            </div>
                        </div>
                    </div>

                    {/* æ’­æ”¾å€ */}
                    <div className="mb-6 flex flex-wrap gap-2 items-center p-4 bg-gray-50 rounded-lg">
                        {!isPlaying ? <button onClick={handlePlay} className="flex items-center gap-1 px-4 py-2 bg-blue-600 text-white rounded"><Icons.Play size={16} /> æ’­æ”¾</button> : <button onClick={handlePause} className="flex items-center gap-1 px-4 py-2 bg-yellow-500 text-white rounded"><Icons.Pause size={16} /> æš«åœ</button>}
                        <button onClick={handleReset} className="flex items-center gap-1 px-4 py-2 bg-gray-500 text-white rounded"><Icons.RotateCcw size={16} /> é‡ç½®</button>
                        <button onClick={handleShowAll} className="flex items-center gap-1 px-4 py-2 bg-gray-200 text-gray-700 rounded">é¡¯ç¤ºå…¨éƒ¨</button>
                        <select value={playSpeed} onChange={(e) => setPlaySpeed(Number(e.target.value))} className="ml-auto p-1 border rounded text-sm bg-white"><option value={2000}>æ…¢</option><option value={1000}>æ­£å¸¸</option><option value={500}>å¿«</option></select>
                    </div>

                    {/* åˆ—è¡¨ */}
                    <div className="space-y-2">
                        {messages.map((msg, idx) => (
                            <div key={msg.id} className={`p-3 rounded border flex justify-between items-center bg-white ${idx >= visibleCount ? 'opacity-50' : 'opacity-100'} ${editingId === msg.id ? 'ring-2 ring-yellow-400 bg-yellow-50' : ''}`}>
                                <div className="flex items-center gap-3 flex-1 overflow-hidden">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs text-white ${msg.side === 'right' ? 'bg-green-500' : 'bg-gray-400'}`}>{msg.side === 'right' ? 'æˆ‘' : 'ä»–'}</div>
                                    <div className="flex-1 min-w-0">
                                        {msg.type === 'image' ? <div className="flex items-center gap-1 text-gray-500 text-sm"><Icons.ImageIcon size={14} /> [åœ–ç‰‡]</div> : <p className="text-sm truncate">{msg.content}</p>}
                                        <p className="text-xs text-gray-400">{msg.time}</p>
                                    </div>
                                </div>
                                <div className="flex gap-1 ml-2">
                                    <button onClick={() => handleEditClick(msg)} className="text-blue-400 p-2"><Icons.Edit2 size={16} /></button>
                                    <button onClick={() => handleDeleteMessage(msg.id)} className="text-red-400 p-2"><Icons.Trash2 size={16} /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* é è¦½å€ (æ”¯æ´ç´”æ·¨æ¨¡å¼èƒŒæ™¯åˆ‡æ›) */}
                <div 
                    onClick={() => isCleanMode && setShowCleanControls(!showCleanControls)}
                    className={`${isCleanMode ? `fixed inset-0 z-[100] ${cleanBgColor}` : 'w-full md:w-1/2 bg-gray-800 relative'} flex items-center justify-center p-4 md:p-8 transition-all duration-300 cursor-pointer md:cursor-auto`}
                >
                    {isCleanMode && showCleanControls && (
                        <div 
                            onClick={(e) => e.stopPropagation()} 
                            className="absolute top-6 right-6 z-[101] bg-white/90 p-4 rounded-lg shadow-lg flex flex-col gap-3"
                        >
                            <div className="flex gap-2">
                                <button onClick={handlePlay} className="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    <Icons.Play size={14} /> æ’­æ”¾
                                </button>
                                <button onClick={handleReset} className="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                    <Icons.RotateCcw size={14} /> é‡ç½®
                                </button>
                            </div>
                            
                            {!isRecording ? (
                                <button onClick={handleStartRecording} className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                                    <Icons.Video size={16} /> éŒ„å½±
                                </button>
                            ) : (
                                <button onClick={handleStopRecording} className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-gray-700 text-white rounded text-sm hover:bg-gray-800 animate-pulse">
                                    <Icons.Square size={16} /> åœæ­¢
                                </button>
                            )}

                            <div className="flex gap-2">
                                <button onClick={toggleCleanBg} className="flex-1 flex items-center justify-center gap-1 px-2 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700" title="åˆ‡æ›èƒŒæ™¯è‰²">
                                    <Icons.Palette size={16} /> èƒŒæ™¯
                                </button>
                                <button onClick={() => setShowCleanControls(false)} className="flex-1 flex items-center justify-center gap-1 px-2 py-2 bg-gray-700 text-white rounded text-sm hover:bg-gray-800" title="éš±è—ä»‹é¢ (é»æ“Šç•«é¢ä»»æ„è™•æ¢å¾©)">
                                    <Icons.EyeOff size={16} /> éš±è—
                                </button>
                            </div>

                            <button onClick={() => setIsCleanMode(false)} className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-gray-200 text-gray-800 rounded text-sm hover:bg-gray-300">
                                <Icons.Minimize size={16} /> é€€å‡ºæ¨¡å¼
                            </button>
                        </div>
                    )}

                    {/* åœ¨ç´”æ·¨æ¨¡å¼ä¸”ä»‹é¢éš±è—æ™‚çš„æç¤º */}
                    {isCleanMode && !showCleanControls && !isRecording && (
                        <div className="absolute top-6 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-full text-sm animate-pulse pointer-events-none z-[101]">
                            é»æ“Šç•«é¢ä»»æ„è™•é¡¯ç¤ºæ§åˆ¶é …
                        </div>
                    )}

                    <div 
                        id="phone-preview-container" 
                        onClick={(e) => e.stopPropagation()}
                        className={`relative w-full max-w-[380px] bg-[#8cabd9] border-black shadow-2xl overflow-hidden flex flex-col
                            ${isCleanMode ? 'h-[90dvh] rounded-[30px] border-[8px]' : 'h-[750px] rounded-[40px] border-[12px]'}
                            transition-all duration-300
                        `}
                    >
                        <div id="phone-status-bar" className="bg-[#8cabd9]/90 px-6 pt-3 pb-1 flex justify-between items-center text-white text-xs font-medium z-20">
                            <span>23:44</span>
                            <div className="flex items-center gap-1.5"><Icons.Signal size={14} /><Icons.Wifi size={14} /><Icons.Battery size={16} /></div>
                        </div>
                        <div id="phone-header" className="bg-[#2a3a50]/90 text-white px-4 py-3 flex items-center justify-between z-20 shadow-md backdrop-blur-sm">
                            <Icons.ArrowLeft size={22} className="cursor-pointer" />
                            <span className="font-bold text-base">{chatTitle}</span>
                            <div className="flex items-center gap-4"><Icons.Phone size={20} /><Icons.Menu size={20} /></div>
                        </div>
                        
                        <div id="chat-content-area" className="flex-1 overflow-y-auto p-4 scrollbar-hide relative" style={{ backgroundImage: bgImage ? `url(${bgImage})` : 'none', backgroundSize: 'cover' }}>
                            {messages.slice(0, visibleCount).map((msg, index) => {
                                const showAvatar = msg.side === 'left' && (index === 0 || messages[index-1].side !== 'left');
                                return (
                                    <div key={msg.id} className={`flex w-full mb-4 ${msg.side === 'right' ? 'justify-end' : 'justify-start'}`}>
                                        {msg.side === 'left' && (
                                            <div className="flex flex-col items-center mr-2 self-start">
                                                {showAvatar ? (
                                                    <div className="w-10 h-10 rounded-full bg-gray-300 border border-gray-400 overflow-hidden">
                                                        {avatar ? <img src={avatar} className="w-full h-full object-cover" /> : <Icons.User className="text-gray-500 w-full h-full p-2" />}
                                                    </div>
                                                ) : <div className="w-10"></div>}
                                            </div>
                                        )}
                                        <div className={`flex flex-col max-w-[70%] ${msg.side === 'right' ? 'items-end' : 'items-start'}`}>
                                            {msg.side === 'left' && showAvatar && <span className="text-xs text-gray-700 mb-1 ml-1">{msg.name}</span>}
                                            <div className="flex items-end gap-1.5">
                                                {msg.side === 'right' && (
                                                    <div className="flex flex-col items-end gap-0.5 text-[10px] text-gray-700 min-w-[30px]">
                                                        {msg.read && <span>å·²è®€</span>}<span>{msg.time}</span>
                                                    </div>
                                                )}
                                                
                                                {msg.type === 'image' ? (
                                                    <div className="overflow-hidden rounded-2xl">
                                                        <img src={msg.content} className="max-w-[200px] h-auto object-cover block" />
                                                    </div>
                                                ) : (
                                                    <div className={`px-3 py-2 text-[15px] leading-relaxed break-words shadow-sm relative whitespace-pre-wrap rounded-2xl ${msg.side === 'right' ? 'bg-[#92e3a9] text-black' : 'bg-white text-black'}`}>
                                                        {msg.content}
                                                    </div>
                                                )}

                                                {msg.side === 'left' && <span className="text-[10px] text-gray-700 self-end min-w-[30px]">{msg.time}</span>}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={chatEndRef}></div>
                        </div>

                        <div id="phone-footer" className="bg-white px-3 py-2 flex items-center gap-3 border-t border-gray-300 z-20">
                            <Icons.Plus size={24} className="text-[#2a3a50]" /><Icons.ImageIcon size={22} className="text-[#2a3a50]" />
                            <div className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm text-gray-400">Aa</div>
                            <Icons.Send size={20} className="text-[#2a3a50]" />
                        </div>
                        <div className="absolute bottom-1 left-1/2 transform -translate-x-1/2 w-1/3 h-1 bg-black rounded-full z-30 opacity-20"></div>
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    </script>
    </body>
    </html>
