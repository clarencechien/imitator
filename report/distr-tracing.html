<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼åˆ†æ•£å¼è¿½è¹¤æ•™å­¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: A dashboard-style SPA with top navigation to switch between thematic sections: "ç¸½è¦½" (concepts & architecture), "è¿½è¹¤ç€è¦½å™¨" (simulated trace list and detail view), "æœå‹™åœ–" (interactive service dependency graph and metrics), and "é€²éšåˆ†æ" (heatmap and other plugin views). This structure transforms the linear tutorial into an exploratory tool, mimicking the actual user experience of Grafana and enhancing learning by allowing non-linear exploration of concepts and their practical applications. -->
    <!-- Visualization & Content Choices: 
        - Architecture Diagram: HTML/CSS Flexbox for a clear data flow visualization. Goal: Inform.
        - Trace List: Interactive HTML table. Goal: Compare/Select.
        - Trace Waterfall: Chart.js Horizontal Bar Chart. Goal: Analyze. Interaction: Click a trace in the table to render its waterfall.
        - Service Graph: HTML/CSS Grid/Flex with JS for interaction. Goal: Relate. Interaction: Click nodes to show metrics.
        - Metrics Table: HTML table with JS interaction to link exemplars. Goal: Correlate.
        - Duration Distribution: Chart.js Bar Chart. Goal: Analyze distribution.
        - All choices are made to provide an interactive, hands-on learning experience without using SVG or Mermaid, adhering to the constraints. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f9f9f9;
        }
        .nav-btn {
            @apply px-4 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-all;
        }
        .nav-btn.active {
            @apply bg-slate-800 text-white shadow-md;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 40vh;
            width: 100%;
            max-width: 900px;
            max-height: 400px;
        }
        .service-node {
            @apply bg-white p-3 border border-slate-300 rounded-lg shadow-md flex flex-col items-center justify-center text-center cursor-pointer transition-transform duration-300 hover:scale-105 hover:shadow-lg;
            z-index: 10;
        }
        .arrow {
            position: absolute;
            background-color: #94a3b8;
            height: 2px;
            transform-origin: left;
            z-index: 0;
        }
        .arrow::after {
            content: '';
            position: absolute;
            right: -1px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 8px solid #94a3b8;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">äº’å‹•å¼åˆ†æ•£å¼è¿½è¹¤æ•™å­¸</h1>
            <p class="mt-2 text-md text-slate-600">ä½¿ç”¨ Tempo, Alloy, å’Œ Grafana æ¢ç´¢å¾®æœå‹™æ•ˆèƒ½</p>
        </header>

        <nav class="flex flex-wrap justify-center gap-2 mb-8">
            <button class="nav-btn active" onclick="showView('overview')">ç¸½è¦½</button>
            <button class="nav-btn" onclick="showView('explorer')">è¿½è¹¤ç€è¦½å™¨</button>
            <button class="nav-btn" onclick="showView('service-graph')">æœå‹™åœ–</button>
            <button class="nav-btn" onclick="showView('advanced')">é€²éšåˆ†æ</button>
        </nav>

        <main id="app-content">
            <!-- Overview Section -->
            <section id="overview" class="content-section active space-y-8">
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-4">ä»€éº¼æ˜¯åˆ†æ•£å¼è¿½è¹¤ï¼Ÿ</h2>
                    <p class="text-slate-700 leading-relaxed">åœ¨ç¾ä»Šçš„é›²ç«¯åŸç”Ÿç’°å¢ƒä¸­ï¼Œä¸€å€‹æ‡‰ç”¨ç¨‹å¼é€šå¸¸ç”±è¨±å¤šå¾®æœå‹™çµ„æˆã€‚ç•¶ä¸€å€‹è«‹æ±‚ç™¼å‡ºæ™‚ï¼Œå®ƒæœƒåˆ†æ•£åˆ°å¤šå€‹æœå‹™ä¸­è™•ç†ã€‚åˆ†æ•£å¼è¿½è¹¤å°±æ˜¯ã€Œè¿½è¹¤ã€é€™å€‹è«‹æ±‚å¾é ­åˆ°å°¾çš„å®Œæ•´è·¯å¾‘ï¼Œè®“æˆ‘å€‘èƒ½äº†è§£å®ƒåœ¨æ¯å€‹ç’°ç¯€çš„è™•ç†æƒ…æ³ã€‚</p>
                    <ul class="mt-4 space-y-2 list-disc list-inside">
                        <li><strong>è¿½è¹¤ (Trace):</strong> ä»£è¡¨ä¸€å€‹è«‹æ±‚çš„å®Œæ•´ç”Ÿå‘½é€±æœŸã€‚</li>
                        <li><strong>Span:</strong> ä»£è¡¨åœ¨ä¸€æ¬¡è¿½è¹¤ä¸­ï¼Œå–®ä¸€æœå‹™åŸ·è¡Œçš„ç‰¹å®šæ“ä½œã€‚ä¸€å€‹è¿½è¹¤ç”±å¤šå€‹ Span çµ„æˆã€‚</li>
                    </ul>
                    <p class="mt-4 text-slate-700 leading-relaxed">å®ƒçš„ä¸»è¦åƒ¹å€¼åœ¨æ–¼ï¼Œç•¶ç³»çµ±å‡ºç¾å»¶é²æ™‚ï¼Œæˆ‘å€‘å¯ä»¥é€éåˆ†æè¿½è¹¤è¨˜éŒ„ï¼Œå¿«é€Ÿæ‰¾å‡ºæ˜¯å“ªå€‹æœå‹™çš„å“ªå€‹æ“ä½œï¼ˆSpanï¼‰é€ æˆäº†æ•ˆèƒ½ç“¶é ¸ï¼Œå¾è€Œç²¾æº–åœ°é€²è¡Œå„ªåŒ–ã€‚</p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-4">ç³»çµ±æ¶æ§‹</h2>
                    <p class="text-slate-600 mb-6">æœ¬æ•™å­¸ä¸­çš„ç³»çµ±ç”±å¤šå€‹å…ƒä»¶å”åŒå·¥ä½œï¼Œå¾ç”¢ç”Ÿè¿½è¹¤è³‡æ–™åˆ°æœ€çµ‚çš„è¦–è¦ºåŒ–åˆ†æï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 text-center text-sm font-medium">
                        <div class="flex flex-col items-center">
                            <div class="p-4 bg-blue-100 border-2 border-blue-300 rounded-lg shadow">K6 Tracing</div>
                            <p class="mt-1 text-xs text-slate-500">ç”¢ç”Ÿå‡è¿½è¹¤è³‡æ–™</p>
                        </div>
                        <div class="text-2xl text-slate-400">â†’</div>
                        <div class="flex flex-col items-center">
                            <div class="p-4 bg-purple-100 border-2 border-purple-300 rounded-lg shadow">Alloy</div>
                            <p class="mt-1 text-xs text-slate-500">æ¥æ”¶ä¸¦è™•ç†è³‡æ–™</p>
                        </div>
                        <div class="text-2xl text-slate-400">â†’</div>
                        <div class="flex flex-col items-center">
                            <div class="p-4 bg-teal-100 border-2 border-teal-300 rounded-lg shadow">Tempo</div>
                             <p class="mt-1 text-xs text-slate-500">å„²å­˜è¿½è¹¤ &<br>ç”¢ç”ŸæŒ‡æ¨™</p>
                        </div>
                         <div class="text-2xl text-slate-400">â†’</div>
                         <div class="flex flex-col items-center">
                            <div class="p-4 bg-red-100 border-2 border-red-300 rounded-lg shadow">Prometheus</div>
                             <p class="mt-1 text-xs text-slate-500">å„²å­˜æŒ‡æ¨™è³‡æ–™</p>
                        </div>
                        <div class="text-2xl text-slate-400">â†’</div>
                        <div class="flex flex-col items-center">
                            <div class="p-4 bg-orange-100 border-2 border-orange-300 rounded-lg shadow">Grafana</div>
                             <p class="mt-1 text-xs text-slate-500">è¦–è¦ºåŒ–èˆ‡åˆ†æ</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trace Explorer Section -->
            <section id="explorer" class="content-section space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-2">è¿½è¹¤ç€è¦½å™¨</h2>
                    <p class="text-slate-600 mb-4">é€™è£¡æ¨¡æ“¬ Grafana çš„ Trace Explorer ä»‹é¢ã€‚ä¸‹æ–¹åˆ—å‡ºäº†ç³»çµ±ä¸­æ•ç²åˆ°çš„æ‰€æœ‰è¿½è¹¤è¨˜éŒ„ã€‚æ‚¨å¯ä»¥é»æ“Šä»»ä½•ä¸€ç­†è¿½è¹¤ï¼Œç‰¹åˆ¥æ˜¯è€—æ™‚è¼ƒé•·çš„ï¼Œä¾†æ·±å…¥åˆ†æå…¶è©³ç´°çš„ Span ç€‘å¸ƒåœ–ï¼Œæ‰¾å‡ºæ•ˆèƒ½ç“¶é ¸ã€‚</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Trace ID</th>
                                    <th scope="col" class="px-6 py-3">èµ·å§‹æœå‹™</th>
                                    <th scope="col" class="px-6 py-3">æ ¹ Span</th>
                                    <th scope="col" class="px-6 py-3">ç¸½è€—æ™‚ (ms)</th>
                                </tr>
                            </thead>
                            <tbody id="traces-table">
                                <!-- Traces will be injected here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="trace-detail-container" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 hidden">
                    <h3 id="trace-detail-title" class="text-xl font-bold mb-4"></h3>
                    <div class="chart-container">
                        <canvas id="trace-waterfall-chart"></canvas>
                    </div>
                    <div id="trace-analysis" class="mt-4 p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-800 rounded"></div>
                </div>
            </section>

            <!-- Service Graph Section -->
            <section id="service-graph" class="content-section space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-2">æœå‹™åœ– (Service Graph)</h2>
                    <p class="text-slate-600 mb-4">æœå‹™åœ–æä¾›äº†ä¸€å€‹å®è§€çš„è¦–è§’ï¼Œå±•ç¤ºç³»çµ±ä¸­å„å¾®æœå‹™ä¹‹é–“çš„ä¾è³´é—œä¿‚ã€è«‹æ±‚é€Ÿç‡å’Œå¥åº·ç‹€æ³ã€‚ç¯€é»ä¹‹é–“çš„ç®­é ­ä»£è¡¨è«‹æ±‚æµå‘ã€‚é»æ“Šä»»ä¸€æœå‹™ç¯€é»å¯ä»¥æŸ¥çœ‹å…¶é—œéµæ•ˆèƒ½æŒ‡æ¨™ï¼ˆMetricsï¼‰ã€‚é€™æœ‰åŠ©æ–¼æˆ‘å€‘å¿«é€Ÿå®šä½æœ‰å•é¡Œçš„æœå‹™ã€‚</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 relative min-h-[400px]" id="service-graph-container">
                    <!-- Nodes -->
                    <div class="service-node absolute top-[40%] left-[5%]" id="node-user">
                        <span>ğŸ‘¤</span>
                        <span>ä½¿ç”¨è€…</span>
                    </div>
                    <div class="service-node absolute top-[40%] left-[25%]" id="node-shop-backend">
                        <span>ğŸ›ï¸</span>
                        <span>shop-backend</span>
                    </div>
                    <div class="service-node absolute top-[10%] left-[50%]" id="node-auth-service">
                        <span>ğŸ”</span>
                        <span>auth-service</span>
                    </div>
                    <div class="service-node absolute top-[40%] left-[50%]" id="node-article-service">
                        <span>ğŸ“°</span>
                        <span>article-service</span>
                    </div>
                    <div class="service-node absolute top-[70%] left-[50%]" id="node-cart-service">
                        <span>ğŸ›’</span>
                        <span>cart-service</span>
                    </div>
                    <div class="service-node absolute top-[40%] left-[75%]" id="node-postgres">
                        <span>ğŸ˜</span>
                        <span>postgres</span>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-bold mb-4">æœå‹™æŒ‡æ¨™</h3>
                    <div id="metrics-display" class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-slate-500">é»æ“Šä¸Šæ–¹åœ–ä¸­çš„ä¸€å€‹æœå‹™ç¯€é»ä¾†æŸ¥çœ‹å…¶è©³ç´°æŒ‡æ¨™ã€‚</p>
                    </div>
                </div>
            </section>

            <!-- Advanced Analysis Section -->
            <section id="advanced" class="content-section space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-2">é€²éšåˆ†æ</h2>
                    <p class="text-slate-600 mb-4">é€™å€‹åˆ†é æ¨¡æ“¬äº† Grafana çš„é€²éšåˆ†æåŠŸèƒ½ï¼Œæä¾›äº†å¦ä¸€ç¨®åˆ†æè¦–è§’ã€‚ä¸‹æ–¹çš„é•·æ¢åœ–æ ¹æ“šæŒçºŒæ™‚é–“å’Œé »ç‡å°‡æ‰€æœ‰ Span è¦–è¦ºåŒ–ï¼Œè®“æˆ‘å€‘èƒ½ä¸€çœ¼çœ‹å‡ºæ•ˆèƒ½åˆ†ä½ˆæƒ…æ³ã€‚</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-bold mb-4">Span æŒçºŒæ™‚é–“åˆ†ä½ˆåœ–</h3>
                     <p class="text-slate-600 mb-4">é€™å¼µåœ–è¡¨é¡¯ç¤ºäº†ä¸åŒæŒçºŒæ™‚é–“å€é–“å…§çš„ Span æ•¸é‡ã€‚é¡è‰²è¶Šæ·±çš„é•·æ¢ï¼Œä»£è¡¨è©²å€é–“çš„ Span è¶Šå¤šã€‚é€™èƒ½å¹«åŠ©æˆ‘å€‘äº†è§£å¤§å¤šæ•¸æ“ä½œçš„è€—æ™‚æƒ…æ³ï¼Œä»¥åŠæ˜¯å¦å­˜åœ¨ç•°å¸¸è€—æ™‚çš„é›¢ç¾¤å€¼ã€‚</p>
                    <div class="chart-container">
                        <canvas id="duration-chart"></canvas>
                    </div>
                </div>
            </section>

        </main>
        
        <footer class="text-center mt-12 text-xs text-slate-500">
            <p>æ­¤äº’å‹•å¼å ±å‘Šæ ¹æ“šå½±ç‰‡å…§å®¹ç”Ÿæˆã€‚</p>
            <p>åŸå§‹è³‡æ–™ä¾†æº: 
                <a href="https://github.com/rslim087a/distributed-tracing-alloy-grafana-tempo" target="_blank" class="text-blue-600 hover:underline">GitHub Repo</a> | 
                <a href="https://kubernetestraining.io/blog/distributed-tracing-tempo-alloy-grafana-(docker)" target="_blank" class="text-blue-600 hover:underline">æ•™å­¸æ–‡ç« </a>
            </p>
        </footer>

    </div>

    <script>
        const views = ['overview', 'explorer', 'service-graph', 'advanced'];
        const navButtons = document.querySelectorAll('.nav-btn');
        let activeChart = null;
        let durationChartInstance = null;

        const traceData = [
            { id: 't1', service: 'shop-backend', rootSpan: 'article-to-cart', duration: 1050, error: true },
            { id: 't2', service: 'shop-backend', rootSpan: 'get-recommendations', duration: 550, error: false },
            { id: 't3', service: 'shop-backend', rootSpan: 'checkout', duration: 680, error: false },
            { id: 't4', service: 'shop-backend', rootSpan: 'article-to-cart', duration: 982, error: true },
            { id: 't5', service: 'shop-backend', rootSpan: 'login', duration: 75, error: false },
            { id: 't6', service: 'shop-backend', rootSpan: 'get-recommendations', duration: 580, error: false },
        ];

        const traceDetails = {
            t1: {
                title: "Trace t1: article-to-cart (1050ms)",
                analysis: "ç“¶é ¸åˆ†æï¼š`place-articles` æ“ä½œè€—æ™‚æœ€é•· (800ms)ï¼Œå…¶å­æ“ä½œ `persist-cart` èŠ±äº† 470msï¼Œæ˜¯ä¸»è¦å»¶é²ä¾†æºã€‚éœ€è¦å„ªåŒ– `cart-service` ä¸­çš„ `persist-cart` å‡½å¼ã€‚",
                spans: [
                    { service: 'shop-backend', name: 'article-to-cart', start: 0, end: 1050, level: 0 },
                    { service: 'shop-backend', name: 'authenticate', start: 5, end: 75, level: 1 },
                    { service: 'auth-service', name: 'authenticate', start: 10, end: 70, level: 2 },
                    { service: 'shop-backend', name: 'get-article', start: 5, end: 605, level: 1 },
                    { service: 'article-service', name: 'get-article', start: 10, end: 600, level: 2 },
                    { service: 'postgres', name: 'select-articles', start: 150, end: 350, level: 3 },
                    { service: 'shop-backend', name: 'place-articles', start: 5, end: 805, level: 1 },
                    { service: 'cart-service', name: 'place-articles', start: 10, end: 800, level: 2 },
                    { service: 'cart-service', name: 'persist-cart', start: 300, end: 770, level: 3 },
                ]
            }
        };

        const serviceMetrics = {
            'user': { name: 'ä½¿ç”¨è€…', rps: 0.33, avg_duration: '-', error_rate: '0%' },
            'shop-backend': { name: 'shop-backend', rps: 0.33, avg_duration: '655ms', error_rate: '24%' },
            'auth-service': { name: 'auth-service', rps: 0.33, avg_duration: '186ms', error_rate: '24%' },
            'article-service': { name: 'article-service', rps: 0.15, avg_duration: '~400ms', error_rate: '0%' },
            'cart-service': { name: 'cart-service', rps: 0.15, avg_duration: '~800ms', error_rate: '0%' },
            'postgres': { name: 'postgres', rps: 0.30, avg_duration: '~200ms', error_rate: '0%' },
        };

        function showView(viewId) {
            views.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            navButtons.forEach(btn => {
                if (btn.getAttribute('onclick') === `showView('${viewId}')`) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (viewId === 'service-graph') {
                setTimeout(setupServiceGraph, 0); 
            }
            if (viewId === 'advanced') {
                renderDurationChart();
            }
        }

        function populateTracesTable() {
            const tableBody = document.getElementById('traces-table');
            tableBody.innerHTML = '';
            traceData.sort((a,b) => b.duration - a.duration).forEach(trace => {
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-gray-50 ${trace.id === 't1' ? 'cursor-pointer' : 'cursor-not-allowed'}`;
                if (trace.id === 't1') {
                    row.onclick = () => showTraceDetail('t1');
                }

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${trace.id} ${trace.id === 't1' ? 'ğŸ”' : ''}</td>
                    <td class="px-6 py-4">${trace.service}</td>
                    <td class="px-6 py-4">${trace.rootSpan}</td>
                    <td class="px-6 py-4 ${trace.error ? 'text-red-500 font-bold' : ''}">${trace.duration}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function showTraceDetail(traceId) {
            const detail = traceDetails[traceId];
            if (!detail) return;
            
            const container = document.getElementById('trace-detail-container');
            container.classList.remove('hidden');
            document.getElementById('trace-detail-title').innerText = detail.title;
            document.getElementById('trace-analysis').innerText = detail.analysis;

            renderWaterfallChart(detail.spans);
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function renderWaterfallChart(spans) {
            const ctx = document.getElementById('trace-waterfall-chart').getContext('2d');
            if (activeChart) {
                activeChart.destroy();
            }

            const colors = ['#38bdf8', '#818cf8', '#a78bfa', '#f472b6', '#fb923c', '#facc15'];

            activeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: spans.map(s => `${' '.repeat(s.level * 2)}${s.service}: ${s.name}`),
                    datasets: [{
                        label: 'Span Duration',
                        data: spans.map(s => [s.start, s.end]),
                        backgroundColor: spans.map(s => colors[s.level % colors.length]),
                        borderColor: spans.map(s => colors[s.level % colors.length]),
                        borderWidth: 1,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const span = spans[context.dataIndex];
                                    const duration = span.end - span.start;
                                    return `${span.service} - ${span.name}: ${duration}ms`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            title: {
                                display: true,
                                text: 'æ™‚é–“ (ms)'
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDurationChart() {
            const ctx = document.getElementById('duration-chart').getContext('2d');
            if (durationChartInstance) {
                durationChartInstance.destroy();
            }
            
            const labels = ['0-100', '100-200', '200-400', '400-600', '600-800', '800-1000', '>1000'];
            const dataPoints = [33, 15, 22, 31, 18, 12, 28];
            const maxVal = Math.max(...dataPoints);

            durationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Span æ•¸é‡',
                        data: dataPoints,
                        backgroundColor: dataPoints.map(v => `rgba(249, 115, 22, ${0.2 + (v/maxVal) * 0.8})`),
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.raw} å€‹ Spans`;
                                }
                            }
                        }
                    },
                    scales: {
                         y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Span æ•¸é‡'
                            }
                        },
                         x: {
                            title: {
                                display: true,
                                text: 'Span æŒçºŒæ™‚é–“å€é–“ (ms)'
                            }
                        }
                    }
                }
            });
        }

        function setupServiceGraph() {
            const container = document.getElementById('service-graph-container');
            const existingArrows = container.querySelectorAll('.arrow');
            existingArrows.forEach(arrow => arrow.remove());
            
            const nodes = {
                user: document.getElementById('node-user'),
                shop: document.getElementById('node-shop-backend'),
                auth: document.getElementById('node-auth-service'),
                article: document.getElementById('node-article-service'),
                cart: document.getElementById('node-cart-service'),
                pg: document.getElementById('node-postgres'),
            };

            const connections = [
                { from: nodes.user, to: nodes.shop },
                { from: nodes.shop, to: nodes.auth },
                { from: nodes.shop, to: nodes.article },
                { from: nodes.shop, to: nodes.cart },
                { from: nodes.article, to: nodes.pg },
                { from: nodes.cart, to: nodes.pg },
            ];
            
            connections.forEach(conn => {
                const fromRect = conn.from.getBoundingClientRect();
                const toRect = conn.to.getBoundingClientRect();
                
                const fromCenterX = conn.from.offsetLeft + fromRect.width / 2;
                const fromCenterY = conn.from.offsetTop + fromRect.height / 2;
                const toCenterX = conn.to.offsetLeft + toRect.width / 2;
                const toCenterY = conn.to.offsetTop + toRect.height / 2;

                const angle = Math.atan2(toCenterY - fromCenterY, toCenterX - fromCenterX);
                
                const x1 = fromCenterX + (fromRect.width / 2) * Math.cos(angle);
                const y1 = fromCenterY + (fromRect.height / 2) * Math.sin(angle);
                const x2 = toCenterX - (toRect.width / 2) * Math.cos(angle);
                const y2 = toCenterY - (toRect.height / 2) * Math.sin(angle);

                const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                const rotation = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);

                const arrow = document.createElement('div');
                arrow.classList.add('arrow');
                arrow.style.width = `${length}px`;
                arrow.style.left = `${x1}px`;
                arrow.style.top = `${y1}px`;
                arrow.style.transform = `rotate(${rotation}deg)`;
                
                container.appendChild(arrow);
            });
            
             Object.entries(nodes).forEach(([key, nodeEl]) => {
                if(nodeEl.dataset.listenerAttached) return;
                nodeEl.dataset.listenerAttached = 'true';

                nodeEl.addEventListener('click', () => {
                    const metrics = serviceMetrics[nodeEl.id.replace('node-', '')];
                    displayServiceMetrics(metrics);
                    document.querySelectorAll('.service-node').forEach(n => n.classList.remove('ring-2', 'ring-blue-500'));
                    nodeEl.classList.add('ring-2', 'ring-blue-500');
                });
            });
        }
        
        function displayServiceMetrics(metrics) {
            const display = document.getElementById('metrics-display');
            display.innerHTML = `
                <h4 class="font-bold text-lg text-slate-800">${metrics.name}</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2 text-sm">
                    <div>
                        <p class="text-slate-500">è«‹æ±‚é€Ÿç‡ (RPS)</p>
                        <p class="font-semibold text-lg">${metrics.rps}</p>
                    </div>
                    <div>
                        <p class="text-slate-500">å¹³å‡å»¶é²</p>
                        <p class="font-semibold text-lg">${metrics.avg_duration}</p>
                    </div>
                     <div>
                        <p class="text-slate-500">éŒ¯èª¤ç‡</p>
                        <p class="font-semibold text-lg ${metrics.error_rate !== '0%' ? 'text-red-500' : ''}">${metrics.error_rate}</p>
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateTracesTable();
            window.addEventListener('resize', () => {
                if (document.getElementById('service-graph').classList.contains('active')) {
                    setupServiceGraph();
                }
            });
        });

    </script>
</body>
</html>
