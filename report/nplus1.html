<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N+1 æŸ¥è©¢å•é¡Œäº’å‹•å¼æŒ‡å—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Visualization & Content Choices: 
        - N+1 Problem Flow: Goal: Inform. Method: HTML/CSS diagram. Interaction: Visual demonstration. Justification: More intuitive than a table for showing the 1-to-N query relationship.
        - ORM Trap: Goal: Engage. Method: Interactive code block. Interaction: Click to reveal generated SQL. Justification: Tangibly demonstrates the "hidden query" problem.
        - Diagnosis Toolkit: Goal: Organize. Method: Clickable cards. Interaction: Reveal details on click. Justification: Organizes various tools into a clean, interactive grid.
        - Solution Explorer: Goal: Compare/Organize. Method: Tabbed interface for code fixes and a clickable HTML/CSS flowchart for architectural fixes. Interaction: Click to switch content. Justification: Breaks down dense solution information into manageable, user-controlled segments.
        - Cost Comparison: Goal: Compare/Inform. Method: Chart.js Line Chart. Interaction: Hover for tooltips. Justification: Provides a powerful visual argument for optimization over hardware scaling. Library: Chart.js (Canvas).
        - All diagrams and visual elements are built using HTML and Tailwind CSS to avoid external image or SVG dependencies.
    -->
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8f7f4;
            color: #3d3d3d;
        }
        .nav-link {
            transition: color 0.3s, border-color 0.3s;
        }
        .nav-link.active {
            color: #c084fc;
            border-bottom-color: #c084fc;
        }
        .content-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .sql-toggle .hidden-sql {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .sql-toggle.active .hidden-sql {
            display: block;
            opacity: 1;
        }
        .tab-button.active {
            background-color: #a855f7;
            color: #ffffff;
        }
        .flowchart-step {
            transition: background-color 0.3s, border-color 0.3s, transform 0.3s;
        }
        .flowchart-step.active, .flowchart-step:hover {
            background-color: #ede9fe;
            border-color: #a855f7;
            transform: scale(1.03);
        }
        .chart-container {
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body class="scroll-smooth">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4">
            <ul class="flex items-center justify-center space-x-4 sm:space-x-6 lg:space-x-8 text-sm sm:text-base overflow-x-auto whitespace-nowrap">
                <li><a href="#problem" class="nav-link font-medium py-4 inline-block border-b-2 border-transparent">å•é¡Œå®šç¾©</a></li>
                <li><a href="#trap" class="nav-link font-medium py-4 inline-block border-b-2 border-transparent">å¸¸è¦‹é™·é˜±</a></li>
                <li><a href="#diagnosis" class="nav-link font-medium py-4 inline-block border-b-2 border-transparent">è¨ºæ–·æ–¹æ³•</a></li>
                <li><a href="#fix" class="nav-link font-medium py-4 inline-block border-b-2 border-transparent">è§£æ±ºæ–¹æ¡ˆ</a></li>
                <li><a href="#cost" class="nav-link font-medium py-4 inline-block border-b-2 border-transparent">æˆæœ¬æ¯”è¼ƒ</a></li>
                <li><a href="#takeaway" class="nav-link font-medium py-4 inline-block border-b-2 border-transparent">æ ¸å¿ƒå¿ƒæ³•</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="intro" class="text-center py-16 md:py-24">
            <h1 class="text-4xl md:text-5xl font-bold text-purple-600 mb-4">æ·±å…¥å‰–æ N+1 æŸ¥è©¢å•é¡Œ</h1>
            <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">å¾ç¾è±¡ã€è§£æ³•åˆ°æ¶æ§‹æ€§é é˜²çš„äº’å‹•å¼æŒ‡å—</p>
            <p class="mt-6 text-gray-500 max-w-2xl mx-auto">ã€Œè‹¥å¿ƒä¸­æ²’æœ‰ N+1 æ¦‚å¿µï¼Œç³»çµ±è®Šæ…¢æ™‚åªèƒ½åŠ æ©Ÿå™¨ï¼Œè€Œé›£ä»¥æ‰¾åˆ°çœŸæ­£ç“¶é ¸ã€‚ã€æœ¬æŒ‡å—å°‡å¸¶æ‚¨ä¸€æ­¥æ­¥æ‹†è§£é€™å€‹å¸¸è¦‹çš„æ•ˆèƒ½æ®ºæ‰‹ã€‚</p>
        </section>

        <div class="space-y-20 md:space-y-32">

            <section id="problem">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-2">1. å•é¡Œå®šç¾©ï¼šä»€éº¼æ˜¯ N+1ï¼Ÿ</h2>
                    <p class="text-gray-600">N+1 æŒ‡çš„æ˜¯ä¸€æ¬¡ä¸»è¦æŸ¥è©¢å¾Œï¼Œåˆé‡å°æ¯ä¸€ç­†çµæœè§¸ç™¼äº† N æ¬¡é¡å¤–çš„é—œè¯æŸ¥è©¢ï¼Œå°è‡´ç¸½æŸ¥è©¢æ•¸æš´å¢ã€‚</p>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-center">ä»¥ã€Œä½¿ç”¨è€…ã€èˆ‡ã€Œè¨‚å–®ã€ç‚ºä¾‹</h3>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
                        <div class="flex flex-col items-center p-6 bg-purple-50 rounded-lg border-2 border-purple-200 w-full md:w-auto">
                            <div class="text-5xl font-bold text-purple-600">1</div>
                            <p class="mt-2 font-semibold">ä¸»æŸ¥è©¢</p>
                            <code class="mt-2 text-sm bg-purple-100 p-2 rounded">SELECT * FROM users;</code>
                            <p class="mt-2 text-xs text-gray-500">å…ˆæŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è€…</p>
                        </div>
                        <div class="text-4xl font-light text-purple-400">+</div>
                        <div class="flex flex-col items-center p-6 bg-orange-50 rounded-lg border-2 border-orange-200 w-full md:w-auto">
                            <div class="text-5xl font-bold text-orange-600">N</div>
                            <p class="mt-2 font-semibold">é—œè¯æŸ¥è©¢ (è¿´åœˆ N æ¬¡)</p>
                            <code class="mt-2 text-sm bg-orange-100 p-2 rounded">SELECT * FROM orders WHERE user_id = ?;</code>
                             <p class="mt-2 text-xs text-gray-500">ç‚ºæ¯ä½ä½¿ç”¨è€…æŸ¥è©¢å…¶è¨‚å–®</p>
                        </div>
                    </div>
                    <div class="mt-8 text-center bg-gray-100 p-4 rounded-lg">
                        <p class="font-bold text-xl">ç¸½æŸ¥è©¢æ¬¡æ•¸ = <span class="text-purple-600">1</span> + <span class="text-orange-600">N</span></p>
                        <p class="mt-2 text-gray-600">è‹¥æœ‰ 10,000 ä½ä½¿ç”¨è€…ï¼Œç³»çµ±å°±éœ€è¦åŸ·è¡Œ 10,001 æ¬¡æŸ¥è©¢ï¼Œæ•ˆèƒ½æ€¥åŠ‡æƒ¡åŒ–ã€‚</p>
                    </div>
                </div>
            </section>

            <section id="trap">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-2">2. å¸¸è¦‹é™·é˜±ï¼šç‚ºä»€éº¼ ORM å®¹æ˜“è¸©é›·ï¼Ÿ</h2>
                    <p class="text-gray-600">ORM é è¨­çš„ã€Œå»¶é²è¼‰å…¥ (Lazy Loading)ã€ç‰¹æ€§ï¼Œè®“æŸ¥è©¢è®Šå¾—éš±å½¢ï¼Œé–‹ç™¼è€…å®¹æ˜“åœ¨ä¸çŸ¥ä¸è¦ºä¸­å¯«å‡º N+1ã€‚</p>
                </div>
                <div class="content-card bg-white p-6 md:p-8 rounded-xl shadow-lg sql-toggle" onclick="this.classList.toggle('active')">
                    <h3 class="font-semibold text-lg mb-4">äº’å‹•ç¯„ä¾‹ï¼šé»æ“Šæ­¤è™•æ­æ›‰èƒŒå¾Œçš„ SQL</h3>
                    <p class="mb-4">ä»¥ä¸‹ Django ORM ç¨‹å¼ç¢¼çœ‹èµ·ä¾†å¾ˆç°¡æ½”ï¼Œä½†å¯¦éš›åŸ·è¡Œäº†å¤šå°‘æŸ¥è©¢ï¼Ÿ</p>
                    <pre class="bg-gray-800 text-white p-4 rounded-lg text-sm md:text-base"><code class="language-python">users = User.objects.all()
for u in users:
    print(u.orders.all())</code></pre>
                    <div class="hidden-sql mt-6 border-t pt-6">
                        <h4 class="font-semibold text-red-600 mb-2">å¯¦éš›ç”¢ç”Ÿçš„ SQL æŸ¥è©¢ï¼š</h4>
                        <div class="bg-red-50 text-red-700 p-4 rounded-lg space-y-2 text-sm">
                            <p><strong>-- æŸ¥è©¢ 1 (ä¸»æŸ¥è©¢) --</strong></p>
                            <p><code>SELECT "users"."id", "users"."name", ... FROM "users";</code></p>
                            <p class="mt-4"><strong>-- æŸ¥è©¢ 2 (é—œè¯æŸ¥è©¢ for user 1) --</strong></p>
                            <p><code>SELECT "orders"."id", ... FROM "orders" WHERE "orders"."user_id" = 1;</code></p>
                            <p class="mt-4"><strong>-- æŸ¥è©¢ 3 (é—œè¯æŸ¥è©¢ for user 2) --</strong></p>
                            <p><code>SELECT "orders"."id", ... FROM "orders" WHERE "orders"."user_id" = 2;</code></p>
                            <p class="mt-4"><strong>... (ç¹¼çºŒåŸ·è¡Œ N æ¬¡)</strong></p>
                        </div>
                        <p class="mt-4 text-center text-gray-600">ç¨‹å¼ç¢¼çœ‹ä¼¼åªæœ‰å…©è¡Œï¼Œå»ç”¢ç”Ÿäº† 1+N æ¬¡çš„è³‡æ–™åº«å¾€è¿”ï¼</p>
                    </div>
                </div>
            </section>
            
            <section id="diagnosis">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-2">3. è¨ºæ–·æ–¹æ³•ï¼šå¦‚ä½•ç™¼ç¾ N+1ï¼Ÿ</h2>
                    <p class="text-gray-600">è¦è§£æ±ºå•é¡Œï¼Œå¿…å…ˆçœ‹è¦‹å•é¡Œã€‚ä»¥ä¸‹æ˜¯å¹¾ç¨®å¸¸ç”¨çš„è¨ºæ–·å·¥å…·èˆ‡æ–¹æ³•ã€‚</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="content-card bg-white p-6 rounded-xl shadow-lg text-center">
                        <div class="text-4xl mb-3">ğŸ“</div>
                        <h3 class="font-semibold text-lg mb-2">SQL Log / Debug æ¨¡å¼</h3>
                        <p class="text-sm text-gray-500">é–‹å•Ÿæ¡†æ¶æˆ–è³‡æ–™åº«çš„æ—¥èªŒåŠŸèƒ½ï¼Œç›´æ¥è§€å¯ŸåŸ·è¡Œçš„æ‰€æœ‰ SQL èªå¥ã€‚</p>
                    </div>
                    <div class="content-card bg-white p-6 rounded-xl shadow-lg text-center">
                        <div class="text-4xl mb-3">â±ï¸</div>
                        <h3 class="font-semibold text-lg mb-2">APM / Profiler</h3>
                        <p class="text-sm text-gray-500">ä½¿ç”¨ New Relicã€Datadog ç­‰å·¥å…·ï¼Œå®ƒå€‘èƒ½è‡ªå‹•åˆ—å‡ºã€Œæœ€å¤šæ¬¡ã€æˆ–ã€Œæœ€æ…¢ã€çš„æŸ¥è©¢ã€‚</p>
                    </div>
                    <div class="content-card bg-white p-6 rounded-xl shadow-lg text-center">
                        <div class="text-4xl mb-3">ğŸ“Š</div>
                        <h3 class="font-semibold text-lg mb-2">è³‡æ–™åº«å±¤é¢åˆ†æ</h3>
                        <p class="text-sm text-gray-500">åˆ©ç”¨ `EXPLAIN`ã€æ…¢æŸ¥è©¢æ—¥èªŒã€`pg_stat_statements` ç­‰è³‡æ–™åº«å…§å»ºå·¥å…·é€²è¡Œåˆ†æã€‚</p>
                    </div>
                    <div class="content-card bg-white p-6 rounded-xl shadow-lg text-center">
                        <div class="text-4xl mb-3">ğŸ¤–</div>
                        <h3 class="font-semibold text-lg mb-2">æ¸¬è©¦æ¡†æ¶ Hook</h3>
                        <p class="text-sm text-gray-500">åœ¨ CI/CD æµç¨‹ä¸­æ•´åˆè‡ªå‹•æª¢æ¸¬å·¥å…· (å¦‚ Bullet)ï¼Œææ—©é˜»æ–· N+1 é€²å…¥ç”Ÿç”¢ç’°å¢ƒã€‚</p>
                    </div>
                </div>
            </section>

            <section id="fix">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-2">4. è§£æ±ºæ–¹æ¡ˆï¼šå¾ç¨‹å¼ç¢¼åˆ°æ¶æ§‹</h2>
                    <p class="text-gray-600">è§£æ±º N+1 ä¸åƒ…æ˜¯ä¿®è£œç¨‹å¼ï¼Œæ›´å¯ä»¥é€éæ¶æ§‹è¨­è¨ˆä¾†æ ¹æœ¬æœçµ•ã€‚</p>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-12">
                    <h3 class="font-semibold text-xl text-center mb-6">Part A: ç¨‹å¼ç¢¼å±¤ç´šçš„å„ªåŒ–ç­–ç•¥</h3>
                    <div id="solutionTabs">
                        <div class="flex flex-wrap justify-center gap-2 mb-6">
                            <button data-tab="eager-loading" class="tab-button px-4 py-2 text-sm font-medium bg-gray-200 rounded-full active">é å…ˆè¼‰å…¥ (Eager Loading)</button>
                            <button data-tab="batch-size" class="tab-button px-4 py-2 text-sm font-medium bg-gray-200 rounded-full">æ‰¹æ¬¡å¤§å°è¨­å®š</button>
                            <button data-tab="dataloader" class="tab-button px-4 py-2 text-sm font-medium bg-gray-200 rounded-full">GraphQL DataLoader</button>
                        </div>
                        <div class="tab-content">
                            <div id="eager-loading-content" class="tab-pane">
                                <h4 class="font-semibold mb-2">ç­–ç•¥ï¼šé å…ˆè¼‰å…¥ (Eager Loading) / Join Fetch</h4>
                                <p class="text-gray-600 mb-4">æ ¸å¿ƒæ€æƒ³æ˜¯å‘Šè¨´ ORMï¼šã€Œå˜¿ï¼æˆ‘ç­‰ä¸€ä¸‹æœƒç”¨åˆ°é—œè¯è³‡æ–™ï¼Œè«‹ä½ å…ˆä¸€æ¬¡å¹«æˆ‘æŸ¥å¥½ã€‚ã€ORM æœƒå°‡å¤šæ¬¡æŸ¥è©¢åˆä½µæˆä¸€æ¬¡ JOIN æˆ–å¦ä¸€ç­† IN å­å¥æŸ¥è©¢ã€‚</p>
                                <pre class="bg-gray-800 text-white p-4 rounded-lg text-sm"><code># Django: ä½¿ç”¨ prefetch_related
users = User.objects.prefetch_related('orders').all()

# Rails: ä½¿ç”¨ includes
users = User.includes(:orders)

# Hibernate: ä½¿ç”¨ JOIN FETCH
FROM User u JOIN FETCH u.orders</code></pre>
                            </div>
                            <div id="batch-size-content" class="tab-pane hidden">
                                <h4 class="font-semibold mb-2">ç­–ç•¥ï¼šæ‰¹æ¬¡å¤§å°è¨­å®š (Batch Size)</h4>
                                <p class="text-gray-600 mb-4">ç•¶ç„¡æ³•ä¸€æ¬¡ JOIN æ™‚ï¼Œå¯ä»¥è¨­å®šä¸€å€‹æ‰¹æ¬¡å¤§å°ï¼Œè®“ ORM åœ¨è§¸ç™¼å»¶é²è¼‰å…¥æ™‚ï¼Œä»¥ `IN (...)` çš„æ–¹å¼ä¸€æ¬¡æ€§è¼‰å…¥ä¸€æ‰¹é—œè¯è³‡æ–™ï¼Œè€Œéä¸€ç­†ä¸€ç­†è¼‰å…¥ã€‚</p>
                                <pre class="bg-gray-800 text-white p-4 rounded-lg text-sm"><code>// Hibernate: åœ¨ Entity ä¸Šè¨­å®š
@BatchSize(size = 25)
private Set<Order> orders;

// æŸ¥è©¢æ™‚æœƒç”¢ç”Ÿé¡ä¼¼ SQL:
// SELECT * FROM orders WHERE user_id IN (?, ?, ..., ?); (å…± 25 å€‹)</code></pre>
                            </div>
                            <div id="dataloader-content" class="tab-pane hidden">
                                <h4 class="font-semibold mb-2">ç­–ç•¥ï¼šGraphQL DataLoader</h4>
                                <p class="text-gray-600 mb-4">åœ¨ GraphQL çš„ Resolver å±¤ï¼ŒDataLoader æœƒè‡ªå‹•æ”¶é›†åŒä¸€å€‹äº‹ä»¶å¾ªç’°ä¸­æ‰€æœ‰å°åŒé¡è³‡æ–™çš„è«‹æ±‚ï¼Œä¸¦å°‡å®ƒå€‘æ‰¹æ¬¡åŒ–æˆå–®ä¸€çš„å¾Œç«¯è«‹æ±‚ï¼Œå¾æ ¹æºä¸Šè§£æ±º N+1ã€‚</p>
                                <pre class="bg-gray-800 text-white p-4 rounded-lg text-sm"><code>// æ¦‚å¿µæ€§ç¨‹å¼ç¢¼
async function userResolver(parent, args, context) {
    // DataLoader æœƒè‡ªå‹•å°‡å¤šå€‹å° orders çš„è«‹æ±‚æ‰¹æ¬¡è™•ç†
    return context.loaders.orders.load(parent.id); 
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <h3 class="font-semibold text-xl text-center mb-6">Part B: æ¶æ§‹å±¤ç´šçš„é é˜²æ€§è¨­è¨ˆ (DDD)</h3>
                    <p class="text-center text-gray-600 mb-8">é€éé ˜åŸŸé©…å‹•è¨­è¨ˆ (DDD) çš„æ ¸å¿ƒåŸå‰‡ï¼Œæˆ‘å€‘å¯ä»¥åœ¨è¨­è¨ˆéšæ®µå°±è®“ N+1 å•é¡Œã€Œç„¡è™•å¯è—ã€ã€‚</p>
                    <div class="space-y-4" id="flowchart-container">
                        <div data-content="content-aggregate" class="flowchart-step cursor-pointer border p-4 rounded-lg flex items-center gap-4">
                            <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">1</div>
                            <div class="font-semibold">åŠƒåˆ†å°èšåˆ (Aggregate)</div>
                        </div>
                        <div id="content-aggregate" class="pl-12 text-sm text-gray-700 hidden pb-4">ä¸€å€‹èšåˆæ ¹åªæ¶µè“‹ã€Œä¸€æ¬¡äº¤æ˜“ä¸­éœ€ä¿æŒä¸€è‡´æ€§ã€çš„è³‡æ–™ï¼Œè·¨èšåˆåªä¿ç•™ ID åƒç…§ï¼Œç¦æ­¢éˆå¼å­˜å–ã€‚</div>
                        
                        <div class="pl-6"><span class="text-2xl text-purple-300">â†“</span></div>
                        
                        <div data-content="content-repository" class="flowchart-step cursor-pointer border p-4 rounded-lg flex items-center gap-4">
                            <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">2</div>
                            <div class="font-semibold">å®šç¾©æ˜ç¢ºçš„ Repository API</div>
                        </div>
                        <div id="content-repository" class="pl-12 text-sm text-gray-700 hidden pb-4">æä¾› `findByIds()` ç­‰æ‰¹æ¬¡æ–¹æ³•ï¼Œä¸¦æ˜ç¢ºå€åˆ† `loadAggregate()` (å¯«) èˆ‡ `loadReadModel()` (è®€)ã€‚</div>

                        <div class="pl-6"><span class="text-2xl text-purple-300">â†“</span></div>

                        <div data-content="content-cqrs" class="flowchart-step cursor-pointer border p-4 rounded-lg flex items-center gap-4">
                            <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">3</div>
                            <div class="font-semibold">æ¡ç”¨ CQRS èˆ‡æŠ•å½± (Projection)</div>
                        </div>
                         <div id="content-cqrs" class="pl-12 text-sm text-gray-700 hidden pb-4">å¯«æ“ä½œèµ°èšåˆï¼Œè®€æ“ä½œç›´æ¥æŸ¥ç‚º UI å„ªåŒ–çš„ã€ŒæŠ•å½±è¡¨ã€ï¼Œå®Œå…¨ç¹é–‹å»¶é²è¼‰å…¥ã€‚</div>

                        <div class="pl-6"><span class="text-2xl text-purple-300">â†“</span></div>

                        <div data-content="content-fuse" class="flowchart-step cursor-pointer border p-4 rounded-lg flex items-center gap-4">
                            <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">4</div>
                            <div class="font-semibold">å»ºç«‹æ¶æ§‹æ€§ä¿éšªçµ²</div>
                        </div>
                        <div id="content-fuse" class="pl-12 text-sm text-gray-700 hidden pb-4">åœ¨ CI/CD èˆ‡ APM ä¸­åŠ å…¥è‡ªå‹•åŒ– N+1 æª¢æ¸¬èˆ‡è­¦å ±ï¼Œä½œç‚ºæœ€å¾Œé˜²ç·šã€‚</div>
                    </div>
                </div>
            </section>

            <section id="cost">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-2">5. æˆæœ¬æ¯”è¼ƒï¼šç¡¬é«”æ“´å…… vs. ç¨‹å¼å„ªåŒ–</h2>
                    <p class="text-gray-600">é¢å° N+1 å•é¡Œï¼Œå¢åŠ ç¡¬é«”åªæ˜¯æš«æ™‚çš„æ­¢ç—›è—¥ï¼Œæˆæœ¬æœƒç·šæ€§å¢é•·ï¼›è€Œæ ¹æœ¬å„ªåŒ–æ‰æ˜¯é•·ä¹…ä¹‹è¨ˆã€‚</p>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <div class="chart-container">
                        <canvas id="costChart"></canvas>
                    </div>
                     <p class="text-center mt-4 text-sm text-gray-500">æ­¤åœ–è¡¨ç‚ºæ¦‚å¿µç¤ºæ„ï¼Œæ¯”è¼ƒå…©ç¨®ç­–ç•¥éš¨ä½¿ç”¨è€…å¢é•·ä¸‹çš„æˆæœ¬è¶¨å‹¢ã€‚</p>
                </div>
            </section>

            <section id="takeaway">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-2">6. æ ¸å¿ƒå¿ƒæ³•ï¼šå¾æ•‘ç«åˆ°é é˜²</h2>
                    <p class="text-gray-600">å°‡ N+1 çš„æ„è­˜å…§åŒ–ç‚ºé–‹ç™¼èˆ‡è¨­è¨ˆçš„è‚Œè‚‰è¨˜æ†¶ã€‚</p>
                </div>
                <div class="bg-purple-600 text-white p-8 md:p-10 rounded-xl shadow-2xl text-center">
                    <p class="text-2xl md:text-3xl font-semibold leading-relaxed">ã€Œæœ‰æ²’æœ‰ ORM ä¸é‡è¦ï¼Œé‡é»æ˜¯è¦æœ‰ã€é‡æ¸¬ SQLã€èˆ‡ã€è¾¨è­˜ N+1ã€çš„è‚Œè‚‰è¨˜æ†¶ã€‚ç•¶æ•ˆèƒ½ä¸‹é™æ™‚ï¼Œå…ˆæ‰“é–‹ query logï¼Œè€Œä¸æ˜¯å…ˆæ‰“é–‹æ¡è³¼å–®ã€‚ã€</p>
                    <hr class="my-6 border-purple-400">
                    <p class="text-lg md:text-xl">çœŸæ­£çš„æ²»æœ¬ä¹‹é“ï¼Œæ˜¯é€éã€Œè¨­è¨ˆã€è®“ N+1 å¾éš±å½¢æ®ºæ‰‹ï¼Œè®Šæˆé¡¯è€Œæ˜“è¦‹ä¸”å®¹æ˜“ä¸€æ¬¡æŠ“å…‰çš„è‡­èŸ²ã€‚</p>
                </div>
            </section>

        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Navigation scroll spy
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.nav-link');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id');
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                });
            }
        });
    }, { rootMargin: '-50% 0px -50% 0px' });

    sections.forEach(section => {
        observer.observe(section);
    });

    // Solution Tabs
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.tab;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            tabPanes.forEach(pane => {
                if (pane.id === `${tabId}-content`) {
                    pane.classList.remove('hidden');
                } else {
                    pane.classList.add('hidden');
                }
            });
        });
    });
    
    // Flowchart interaction
    const flowchartSteps = document.querySelectorAll('.flowchart-step');
    flowchartSteps.forEach(step => {
        step.addEventListener('click', () => {
            const contentId = step.dataset.content;
            const contentEl = document.getElementById(contentId);
            const isActive = step.classList.contains('active');
            
            // Deactivate all
            flowchartSteps.forEach(s => s.classList.remove('active'));
            document.querySelectorAll('#flowchart-container [id^="content-"]').forEach(c => c.classList.add('hidden'));

            if (!isActive) {
                step.classList.add('active');
                contentEl.classList.remove('hidden');
            }
        });
    });

    // Cost Comparison Chart
    const ctx = document.getElementById('costChart').getContext('2d');
    const costChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['0', '2k', '4k', '6k', '8k', '10k Users'],
            datasets: [{
                label: 'æˆæœ¬ï¼šæ©«å‘æ“´å……ç¡¬é«” (N+1 æœªè§£æ±º)',
                data: [100, 2000, 4000, 6000, 8000, 10000],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.1
            }, {
                label: 'æˆæœ¬ï¼šä¸€æ¬¡æ€§ç¨‹å¼ç¢¼/æ¶æ§‹å„ªåŒ–',
                data: [1500, 1500, 1500, 1500, 1500, 1500],
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderDash: [5, 5],
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'ç›¸å°æˆæœ¬'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ä½¿ç”¨è€…/è³‡æ–™é‡'
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                },
                legend: {
                    position: 'bottom',
                },
            }
        }
    });
});
</script>

</body>
</html>
