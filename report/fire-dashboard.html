import React, { useState } from 'react';
import { AlertTriangle, TrendingUp, DollarSign, PieChart, Activity, History, ShieldCheck, ExternalLink, ChevronDown, ChevronUp, BookOpen, CheckCircle, XCircle } from 'lucide-react';

export default function FireDashboard() {
  // --- 狀態變數 ---
  // 允許狀態為空字串 '' 以解決輸入框 "0100" 的體驗問題
  const [totalAssets, setTotalAssets] = useState(30000000);
  const [cape, setCape] = useState(35);
  const [currentBondHoldings, setCurrentBondHoldings] = useState(12000000);
  const [isDetailsOpen, setIsDetailsOpen] = useState(false); 
  
  // 系統常數
  const CONST_A = 1.75;
  const CONST_B = 0.5;

  // --- 安全數值轉換 (用於計算) ---
  // 如果狀態是空字串，計算時視為 0
  const valTotalAssets = totalAssets === '' ? 0 : totalAssets;
  const valCape = cape === '' ? 0 : cape;
  const valBondHoldings = currentBondHoldings === '' ? 0 : currentBondHoldings;
  
  // --- 計算邏輯 ---
  // CAPE 防呆：若為 0 或空，視為無限大 (SWR 取基礎值)，避免除以零
  const effectiveCape = valCape > 0 ? valCape : Infinity;
  const swr = CONST_A + (CONST_B * (1 / effectiveCape)) * 100;
  const swrDisplay = swr.toFixed(2);
  
  const annualBudget = valTotalAssets * (swr / 100);
  const quarterlyWithdrawal = annualBudget / 4;
  const monthlyBudget = annualBudget / 12;
  
  const currentEquityHoldings = valTotalAssets - valBondHoldings;
  
  // 比率計算防呆 (分母為 0 時回傳 0)
  const equityRatio = valTotalAssets > 0 ? (currentEquityHoldings / valTotalAssets) * 100 : 0;
  const bondRatio = valTotalAssets > 0 ? (valBondHoldings / valTotalAssets) * 100 : 0;
  
  // 自動計算：債券還能撐幾年 (Bond Runway)
  let bondRunwayYears = "0.0";
  if (annualBudget > 0) {
    bondRunwayYears = (valBondHoldings / annualBudget).toFixed(1);
  } else if (valBondHoldings > 0) {
    bondRunwayYears = "∞"; // 有債券但預算為 0，可撐無限久
  }
  
  const isAusterity = swr < 3.0;
  
  const formatCurrency = (num) => {
    // 處理 NaN 或 Infinity
    if (!Number.isFinite(num)) return "$0";
    return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(num);
  };

  // 輔助顯示：將大數字轉為中文單位
  const formatChineseUnit = (num) => {
    const n = Number(num);
    if (!n) return ""; // 若為 0 或空字串，不顯示輔助文字
    if (n >= 100000000) {
      return (n / 100000000).toFixed(2) + " 億";
    } else if (n >= 10000) {
      return (n / 10000).toFixed(0) + " 萬";
    }
    return n;
  };

  // 通用輸入處理函式
  const handleInputChange = (setter) => (e) => {
    const val = e.target.value;
    // 關鍵修正：如果輸入框清空，設為空字串 ''，否則轉為數字
    setter(val === '' ? '' : Number(val));
  };

  return (
    <div className="min-h-screen bg-slate-900 p-6 md:p-10 font-sans text-slate-200 text-lg font-medium">
      <div className="max-w-5xl mx-auto space-y-8">
        
        {/* Header */}
        <header className="bg-slate-800 p-8 rounded-2xl shadow-lg border border-slate-700 flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-3xl md:text-4xl font-extrabold text-white tracking-tight">FIRE 動態提領引擎</h1>
            <p className="text-slate-300 text-base md:text-lg mt-2 font-semibold">基於 Bigern CAPE 估值調整模型 (FDE-60)</p>
          </div>
          <div className="flex gap-2">
            <span className="px-4 py-2 bg-slate-700 text-slate-100 rounded-full text-sm font-bold border border-slate-600 shadow-sm">
              v1.5 Input Fix
            </span>
          </div>
        </header>

        {/* 輸入區塊 */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          
          {/* 1. 總資產 */}
          <div className="bg-slate-800 p-6 rounded-2xl shadow-md border border-slate-700 flex flex-col justify-center group hover:border-blue-500/50 transition-colors">
            <label className="block text-lg font-bold text-slate-300 mb-3">總資產市值 (NTD)</label>
            <div className="relative">
              <DollarSign className="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-400 group-hover:text-blue-400 transition-colors" />
              <input 
                type="number" 
                value={totalAssets}
                onChange={handleInputChange(setTotalAssets)}
                placeholder="0"
                className="w-full pl-12 pr-4 py-4 bg-slate-900 border border-slate-600 text-white text-2xl rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-bold placeholder-slate-700"
              />
            </div>
            <p className="text-right text-base text-blue-400 mt-2 font-bold h-6">
              {formatChineseUnit(totalAssets)}
            </p>
          </div>

          {/* 2. CAPE 指數 */}
          <div className="bg-slate-800 p-6 rounded-2xl shadow-md border border-slate-700 flex flex-col justify-center relative overflow-hidden group hover:border-blue-500/50 transition-colors">
            <div className="flex justify-between items-center mb-3">
              <label className="block text-lg font-bold text-slate-300">當前 CAPE 指數</label>
              <a href="https://www.multpl.com/shiller-pe" target="_blank" rel="noreferrer" className="flex items-center gap-1 text-sm text-blue-400 hover:text-blue-300 hover:underline transition-colors font-semibold">
                查詢 Multpl <ExternalLink className="w-4 h-4" />
              </a>
            </div>

            <div className="relative">
              <Activity className="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-400 group-hover:text-blue-400 transition-colors" />
              <input 
                type="number" 
                value={cape}
                onChange={handleInputChange(setCape)}
                placeholder="0"
                className="w-full pl-12 pr-4 py-4 bg-slate-900 border border-slate-600 text-white text-2xl rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-bold placeholder-slate-700"
              />
            </div>
            
            <div className="flex gap-2 mt-3 justify-end">
              <button onClick={() => setCape(17)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold text-slate-200 transition-colors" title="歷史平均">
                Avg (17)
              </button>
              <button onClick={() => setCape(44)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold text-slate-200 transition-colors" title="網路泡沫高點">
                High (44)
              </button>
              <button onClick={() => setCape(13)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold text-slate-200 transition-colors" title="金融海嘯低點">
                Low (13)
              </button>
            </div>
          </div>

          {/* 3. 債券部位 */}
          <div className="bg-slate-800 p-6 rounded-2xl shadow-md border border-slate-700 flex flex-col justify-center group hover:border-blue-500/50 transition-colors">
            <label className="block text-lg font-bold text-slate-300 mb-3">目前債券部位 (NTD)</label>
            <div className="relative">
              <PieChart className="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-400 group-hover:text-blue-400 transition-colors" />
              <input 
                type="number" 
                value={currentBondHoldings}
                onChange={handleInputChange(setCurrentBondHoldings)}
                placeholder="0"
                className="w-full pl-12 pr-4 py-4 bg-slate-900 border border-slate-600 text-white text-2xl rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-bold placeholder-slate-700"
              />
            </div>
             <p className="text-right text-base text-blue-400 mt-2 font-bold h-6">
              {formatChineseUnit(currentBondHoldings)}
            </p>
          </div>
        </div>

        {/* 核心儀表板 */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          
          {/* 1. 提領預算卡片 */}
          <div className={`bg-slate-800 p-8 rounded-2xl shadow-md border-l-8 ${isAusterity ? 'border-l-red-500' : 'border-l-green-500'} border-y border-r border-slate-700 relative overflow-hidden`}>
            <h2 className="text-2xl font-extrabold text-white flex items-center mb-6">
              <TrendingUp className="w-8 h-8 mr-3 text-slate-300" />
              年度提領計畫
            </h2>
            
            <div className="space-y-6">
              <div className="flex justify-between items-end pb-4 border-b border-slate-700">
                <span className="text-slate-300 text-lg font-bold">計算 SWR (安全提領率)</span>
                <div className="text-right">
                   <span className={`text-5xl font-extrabold ${isAusterity ? 'text-red-400' : 'text-green-400'}`}>
                    {swrDisplay}%
                  </span>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4 pb-4 border-b border-slate-700">
                <div>
                  <span className="text-slate-300 text-sm block mb-1 font-bold">本年度總預算</span>
                  <span className="text-2xl font-extrabold text-white">
                    {formatCurrency(annualBudget)}
                  </span>
                </div>
                <div className="text-right">
                  <span className="text-slate-300 text-sm block mb-1 font-bold">換算月薪</span>
                  <span className="text-2xl font-extrabold text-slate-200">
                    {formatCurrency(monthlyBudget)}
                  </span>
                </div>
              </div>

              <div className="bg-slate-900/60 p-6 rounded-xl border border-slate-700/50 text-center">
                <p className="text-sm text-slate-400 uppercase tracking-wide mb-2 font-extrabold">本季應提領金額 (1/4/7/10月)</p>
                <p className="text-4xl md:text-5xl font-black text-blue-400 tracking-tight">
                  {formatCurrency(quarterlyWithdrawal)}
                </p>
              </div>

              {isAusterity && (
                <div className="flex items-start gap-4 p-4 bg-red-900/20 border border-red-900/30 text-red-200 text-base rounded-xl">
                  <AlertTriangle className="w-6 h-6 shrink-0 text-red-400 mt-1" />
                  <div>
                    <strong className="text-red-300 text-lg block mb-1 font-extrabold">樽節警告 (Austerity Warning)</strong>
                    <p className="text-red-200/90 leading-relaxed font-semibold">
                      CAPE 過高導致 SWR 低於 3%。建議啟動 Barista FIRE 或縮減非必要開支。
                    </p>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* 2. 資產配置與滑翔路徑 */}
          <div className="bg-slate-800 p-8 rounded-2xl shadow-md border border-slate-700">
             <h2 className="text-2xl font-extrabold text-white flex items-center mb-6">
              <PieChart className="w-8 h-8 mr-3 text-slate-300" />
              資產配置狀態 (Glidepath)
            </h2>

            <div className="space-y-6">
              <div className="grid grid-cols-2 gap-6">
                <div className="text-center p-5 bg-blue-900/20 border border-blue-800/30 rounded-xl">
                  <p className="text-sm font-extrabold text-blue-300 mb-2 uppercase">股票 (VT)</p>
                  <p className="text-4xl font-extrabold text-blue-100">{equityRatio.toFixed(1)}%</p>
                  <p className="text-base font-bold text-slate-300 mt-1">{formatCurrency(currentEquityHoldings)}</p>
                </div>
                <div className="text-center p-5 bg-amber-900/20 border border-amber-800/30 rounded-xl relative">
                  <p className="text-sm font-extrabold text-amber-300 mb-2 uppercase">債券 (VGIT)</p>
                  <p className="text-4xl font-extrabold text-amber-100">{bondRatio.toFixed(1)}%</p>
                  <p className="text-base font-bold text-slate-300 mt-1">{formatCurrency(currentBondHoldings)}</p>
                </div>
              </div>
              
              <div className="flex items-center justify-between bg-slate-700/40 p-5 rounded-lg border border-slate-600/50">
                <div className="flex items-center gap-3 text-slate-200">
                  <ShieldCheck className="w-6 h-6 text-green-400" />
                  <span className="text-base font-bold">目前債券存量 (Runway)</span>
                </div>
                <div className="text-right">
                  <span className={`text-2xl font-black ${Number(bondRunwayYears) < 2 && Number(bondRunwayYears) !== 0 ? 'text-red-400' : 'text-white'}`}>
                    {bondRunwayYears} 年
                  </span>
                  <span className="text-sm font-bold text-slate-400 ml-2">生活費</span>
                </div>
              </div>

              <div className="bg-slate-900 text-slate-200 p-6 rounded-xl shadow-inner border border-slate-700">
                <h3 className="text-base font-extrabold text-slate-300 uppercase mb-4 tracking-wider">本季執行建議 (SOP)</h3>
                <div className="space-y-4 text-lg">
                  <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-1">
                    <span className="text-slate-400 font-bold">1. 提領需求：</span>
                    <span className="font-mono text-xl text-yellow-400 font-black">{formatCurrency(quarterlyWithdrawal)}</span>
                  </div>
                  <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-1">
                    <span className="text-slate-400 font-bold">2. 賣出標的：</span>
                    {valBondHoldings > quarterlyWithdrawal ? (
                      <span className="font-extrabold text-xl text-green-400">優先賣出 VGIT (債券)</span>
                    ) : (
                      <span className="font-extrabold text-xl text-blue-400">債券不足，開始賣出 VT (股票)</span>
                    )}
                  </div>
                  <p className="text-base text-slate-400 mt-4 pt-4 border-t border-slate-800 leading-relaxed font-semibold">
                    * 說明：系統偵測您尚有 <span className="text-white font-extrabold">{bondRunwayYears} 年</span> 的債券存糧。請優先消耗債券以執行滑翔路徑，保留股票對抗長期通膨。
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {/* 可收合的詳細說明書 Widget */}
        <div className="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden transition-all duration-300">
          <button 
            onClick={() => setIsDetailsOpen(!isDetailsOpen)}
            className="w-full p-6 flex items-center justify-between bg-slate-800 hover:bg-slate-750 transition-colors"
          >
            <div className="flex items-center gap-3">
              <BookOpen className="w-6 h-6 text-blue-400" />
              <h3 className="text-xl font-extrabold text-white">完整提領計畫說明書 & SOP</h3>
            </div>
            {isDetailsOpen ? <ChevronUp className="w-6 h-6 text-slate-400" /> : <ChevronDown className="w-6 h-6 text-slate-400" />}
          </button>
          
          {isDetailsOpen && (
            <div className="p-8 pt-0 border-t border-slate-700 bg-slate-800/50">
              {/* TL;DR */}
              <div className="mb-8 bg-slate-900/50 p-6 rounded-xl border-l-4 border-blue-500 mt-6">
                <h4 className="text-lg font-black text-blue-300 mb-2 uppercase tracking-wide">TL;DR 核心懶人包</h4>
                <p className="text-slate-200 leading-relaxed">
                  每年 1/1 計算今年能花多少錢，每季 (1/4/7/10月) 提領一次。
                  <br />
                  原則：<strong>優先賣債券 (VGIT)</strong> 來過生活，把股票 (VT) 留著對抗長達 60 年的通膨。只有當債券用光，或股市極度大漲時，才考慮賣股票。
                </p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                {/* Do's */}
                <div>
                  <h4 className="flex items-center gap-2 text-green-400 font-black text-lg mb-4">
                    <CheckCircle className="w-6 h-6" />
                    Do (必做清單)
                  </h4>
                  <ul className="space-y-3">
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-green-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">每年 1/1 登入更新「總資產」與「CAPE 指數」，算出年度預算。</span>
                    </li>
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-green-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">優先賣出 <strong className="text-white">VGIT (美國公債)</strong> 支付生活費 (滑翔路徑)。</span>
                    </li>
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-green-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">保持至少 <strong className="text-white">2 年份</strong> 的債券存糧 (Runway)。</span>
                    </li>
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-green-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">若 CAPE &gt; 30，要有心理準備該年預算會縮水，考慮減少旅遊等非必要支出。</span>
                    </li>
                  </ul>
                </div>

                {/* Don'ts */}
                <div>
                  <h4 className="flex items-center gap-2 text-red-400 font-black text-lg mb-4">
                    <XCircle className="w-6 h-6" />
                    Don't (絕對禁止)
                  </h4>
                  <ul className="space-y-3">
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">禁止買 <strong className="text-red-300">BND/公司債</strong>。避險部位必須是純公債，否則股災時會跟著跌。</span>
                    </li>
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">禁止在 1 月一次提領整年份現金 (會造成現金拖累，降低報酬)。</span>
                    </li>
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">禁止在股市大跌時恐慌賣出 VT (股票)。這時候是債券發揮作用的時候。</span>
                    </li>
                    <li className="flex gap-3 items-start">
                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mt-2.5 shrink-0"></span>
                      <span className="text-slate-300">禁止在台灣帳戶保留超過 6 個月的生活費。</span>
                    </li>
                  </ul>
                </div>
              </div>

              {/* 詳細步驟 */}
              <div>
                <h4 className="text-lg font-black text-white mb-4 border-b border-slate-700 pb-2">詳細執行步驟 (SOP)</h4>
                <div className="space-y-6">
                  <div>
                    <h5 className="text-blue-300 font-bold text-base mb-2">Step 1: 年度健檢 (每年 1 月 1 日)</h5>
                    <p className="text-slate-400 text-base leading-relaxed">
                      打開此儀表板，輸入 12/31 收盤後的總資產。去 Multpl.com 查最新的 CAPE 指數。
                      系統會告訴你今年可以花多少錢。如果數字比去年少，請調整心態，這是為了保護你的本金能撐 60 年。
                    </p>
                  </div>
                  <div>
                    <h5 className="text-blue-300 font-bold text-base mb-2">Step 2: 季度提領 (1/4/7/10 月)</h5>
                    <p className="text-slate-400 text-base leading-relaxed">
                      登入美股券商。優先使用配息。不足的部分，賣出 VGIT (債券)。
                      將美金匯回台灣。記得，操作完就關掉網頁，不要去看股票漲跌，也不要嘗試預測市場。
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}
