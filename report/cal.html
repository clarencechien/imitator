<!DOCTYPE html>
<html lang="zh-Hant" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>無限滾動月曆</title>
    
    <!-- 讓網頁在手機上看起來像原生App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 引用字體和 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS 變數，用於動態調整間距 */
        :root {
            --vertical-day-padding: 0.5rem; /* 日期格子的上下內距 */
            --horizontal-page-padding: 1rem; /* 整個月份區塊的左右內距 */
        }
        body {
            font-family: 'LXGW WenKai TC', cursive;
            background-color: #F8F4E8;
            overscroll-behavior-y: contain; /* 防止在iOS上滾動時，整個網頁被拉動 */
        }
        .calendar-month {
            /* 使用 CSS 變數來控制左右 padding，達到可調整的滿版效果 */
            padding: 1rem var(--horizontal-page-padding) 3rem var(--horizontal-page-padding);
            transition: padding 0.1s ease-out; /* 讓間距調整更平滑 */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex-grow: 1; 
        }
        .calendar-day {
            position: relative; /* 讓花瓣定位的基準 */
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #f3f4f6;
            border-right: 1px solid #f3f4f6;
            font-size: clamp(1rem, 4vw, 1.5rem); /* 字體大小隨螢幕寬度自適應 */
            /* 使用 CSS 變數來控制日期的上下 padding */
            padding: var(--vertical-day-padding) 0.25rem;
            transition: padding 0.1s ease-out;
        }
        /* 移除每行最右邊的格線 */
        .calendar-grid > .calendar-day:nth-child(7n) {
            border-right: none;
        }
        .saturday { color: #5A8F7B; }
        .sunday { color: #D97706; }
        /* "今天" 的樣式 */
        .today {
            background-color: #D97706;
            color: white;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 控制面板的顯示/隱藏樣式 */
        #controls-panel {
            transition: transform 0.3s ease-in-out;
        }
        #controls-panel.hidden {
            transform: translateY(100%);
        }

        /* 花瓣動畫樣式 */
        .petal {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: #D97706;
            border-radius: 6px 0;
            transform-origin: center center;
            animation: ripple-petal 0.7s ease-out forwards;
            /* --r (旋轉角度) 將由 JS 設定 */
        }

        @keyframes ripple-petal {
            from {
                transform: translate(-50%, -50%) rotate(var(--r)) translateY(0) scale(0.5);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -50%) rotate(var(--r)) translateY(-50px) scale(1.2);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="antialiased text-gray-800 h-full overflow-hidden">

    <!-- 月曆容器，移除滾動吸附 -->
    <div id="calendar-container" class="h-full w-full overflow-y-auto">
        <!-- 月份將會由 JavaScript 動態插入此處 -->
    </div>

    <!-- 控制面板 -->
    <div id="controls-panel" class="fixed bottom-0 left-0 w-full bg-white/70 backdrop-blur-sm p-4 shadow-[0_-2px_10px_rgba(0,0,0,0.1)]">
        <div class="w-full max-w-xs mx-auto space-y-2">
            <div class="flex items-center justify-center space-x-2">
                <label for="line-spacing-slider" class="text-sm text-gray-600 whitespace-nowrap">上下行距</label>
                <input type="range" id="line-spacing-slider" min="0" max="20" value="5" class="w-full">
            </div>
            <div class="flex items-center justify-center space-x-2">
                <label for="page-padding-slider" class="text-sm text-gray-600 whitespace-nowrap">左右邊界</label>
                <input type="range" id="page-padding-slider" min="0" max="40" value="10" class="w-full">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('calendar-container');
            const controlsPanel = document.getElementById('controls-panel');
            const lineSpacingSlider = document.getElementById('line-spacing-slider');
            const pagePaddingSlider = document.getElementById('page-padding-slider');
            const root = document.documentElement;

            let currentDate = new Date();
            let currentYear = currentDate.getFullYear();
            let currentMonth = currentDate.getMonth();
            let observer;

            // 產生單一月份的 HTML 結構
            function generateMonthHTML(year, month) {
                const date = new Date(year, month, 1);
                const monthName = `${date.getFullYear()}年 ${date.getMonth() + 1}月`;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayIndex = date.getDay();
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

                let daysHTML = '';
                for (let i = 0; i < firstDayIndex; i++) {
                    daysHTML += `<div class="calendar-day"></div>`;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayIndex = (firstDayIndex + i - 1) % 7;
                    let dayClass = 'calendar-day';
                    let spanClass = 'font-medium';

                    if (dayIndex === 6) spanClass += ' saturday';
                    if (dayIndex === 0) spanClass += ' sunday';
                    if (isCurrentMonth && i === today.getDate()) {
                        spanClass += ' today';
                    }

                    daysHTML += `<div class="${dayClass}"><span class="${spanClass}">${i}</span></div>`;
                }
                
                const totalCells = firstDayIndex + daysInMonth;
                const remainingCells = (7 - (totalCells % 7)) % 7;
                 for (let i = 0; i < remainingCells; i++) {
                    daysHTML += `<div class="calendar-day"></div>`;
                }

                return `
                    <div class="calendar-month w-full flex flex-col" data-year="${year}" data-month="${month}">
                        <div class="text-center mb-4 flex-shrink-0">
                            <h1 class="text-3xl font-bold text-[#283618]">${monthName}</h1>
                        </div>
                        <div class="grid grid-cols-7 text-center font-bold text-gray-600 mb-2 flex-shrink-0">
                            <div class="sunday">日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div class="saturday">六</div>
                        </div>
                        <div class="calendar-grid text-center">
                            ${daysHTML}
                        </div>
                    </div>
                `;
            }
            
            // 更新觀察器
            function updateObserver() {
                if (observer) observer.disconnect();
                observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            if (entry.target === container.firstElementChild) loadPreviousMonth();
                            else if (entry.target === container.lastElementChild) loadNextMonth();
                        }
                    });
                }, { root: container, threshold: 0.1 });

                if (container.firstElementChild) observer.observe(container.firstElementChild);
                if (container.lastElementChild) observer.observe(container.lastElementChild);
            }

            // 載入下一個月
            function loadNextMonth() {
                const lastMonthDiv = container.lastElementChild;
                if (!lastMonthDiv) return;
                let year = parseInt(lastMonthDiv.dataset.year);
                let month = parseInt(lastMonthDiv.dataset.month);
                
                month++;
                if (month > 11) {
                    month = 0;
                    year++;
                }
                container.insertAdjacentHTML('beforeend', generateMonthHTML(year, month));
                updateObserver();
            }

            // 載入上一個月
            function loadPreviousMonth() {
                const firstMonthDiv = container.firstElementChild;
                if (!firstMonthDiv) return;
                const oldScrollHeight = container.scrollHeight;
                let year = parseInt(firstMonthDiv.dataset.year);
                let month = parseInt(firstMonthDiv.dataset.month);

                month--;
                if (month < 0) {
                    month = 11;
                    year--;
                }
                container.insertAdjacentHTML('afterbegin', generateMonthHTML(year, month));
                const newScrollHeight = container.scrollHeight;
                container.scrollTop += (newScrollHeight - oldScrollHeight);
                updateObserver();
            }

            // 建立花瓣漣漪動畫
            function createPetalRipple(element) {
                const petalCount = 6;
                for (let i = 0; i < petalCount; i++) {
                    const petal = document.createElement('div');
                    petal.classList.add('petal');
                    const rotation = (360 / petalCount) * i;
                    petal.style.setProperty('--r', `${rotation}deg`);
                    element.appendChild(petal);
                    petal.addEventListener('animationend', () => petal.remove());
                }
            }

            // 統一的點擊事件處理
            container.addEventListener('click', (e) => {
                const daySpan = e.target.closest('.calendar-day > span');
                if (daySpan && daySpan.textContent.trim() !== '') {
                    const dayCell = daySpan.parentElement;
                    if (dayCell.querySelector('.petal')) return; 
                    createPetalRipple(dayCell);
                } else if (e.target.closest('#controls-panel')) {
                    return;
                } else {
                    controlsPanel.classList.toggle('hidden');
                }
            });

            // 初始化月曆
            function init() {
                const prevMonthDate = new Date(currentYear, currentMonth - 1);
                const nextMonthDate = new Date(currentYear, currentMonth + 1);
                container.innerHTML = `
                    ${generateMonthHTML(prevMonthDate.getFullYear(), prevMonthDate.getMonth())}
                    ${generateMonthHTML(currentYear, currentMonth)}
                    ${generateMonthHTML(nextMonthDate.getFullYear(), nextMonthDate.getMonth())}
                `;
                const currentMonthEl = container.querySelector(`[data-year="${currentYear}"][data-month="${currentMonth}"]`);
                if (currentMonthEl) {
                    currentMonthEl.scrollIntoView({ behavior: 'auto' });
                }
                updateObserver();
            }

            // 間距滑桿事件監聽
            lineSpacingSlider.addEventListener('input', (e) => {
                const padding = e.target.value / 10; // 單位是 rem
                root.style.setProperty('--vertical-day-padding', `${padding}rem`);
            });
            pagePaddingSlider.addEventListener('input', (e) => {
                const padding = e.target.value / 10; // 單位是 rem
                root.style.setProperty('--horizontal-page-padding', `${padding}rem`);
            });


            init();
        });
    </script>
</body>
</html>

